<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>IBM联合科研项目 | Val-Blog</title><meta name="author" content="Val,10425999@qq.com, val213666@gmail.com"><meta name="copyright" content="Val"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前置工作环境配置Prometheus+Grafana环境：Ubuntu 22.04  参考：  https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;8d2c020313f0  https:&#x2F;&#x2F;www.cnblogs.com&#x2F;crazymakercircle&#x2F;p&#x2F;16768535.html  https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_31725371&#x2F;article&#x2F;details&#x2F;1146">
<meta property="og:type" content="article">
<meta property="og:title" content="IBM联合科研项目">
<meta property="og:url" content="https://val213.github.io/2024/05/31/IBM%E4%BF%B1%E4%B9%90%E9%83%A8/IBM%E8%81%94%E5%90%88%E7%A7%91%E7%A0%94%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="Val-Blog">
<meta property="og:description" content="前置工作环境配置Prometheus+Grafana环境：Ubuntu 22.04  参考：  https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;8d2c020313f0  https:&#x2F;&#x2F;www.cnblogs.com&#x2F;crazymakercircle&#x2F;p&#x2F;16768535.html  https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_31725371&#x2F;article&#x2F;details&#x2F;1146">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2024-05-31T09:02:36.093Z">
<meta property="article:modified_time" content="2024-11-21T17:50:37.065Z">
<meta property="article:author" content="Val">
<meta property="article:tag" content="Prometheus">
<meta property="article:tag" content="Grafana">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://val213.github.io/2024/05/31/IBM%E4%BF%B1%E4%B9%90%E9%83%A8/IBM%E8%81%94%E5%90%88%E7%A7%91%E7%A0%94%E9%A1%B9%E7%9B%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Val","link":"Link: ","source":"Source: Val-Blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'IBM联合科研项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-22 01:50:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://github.com/val213/image/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230630230143.jpg?raw=true" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">135</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">108</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Val-Blog"><span class="site-name">Val-Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">IBM联合科研项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-05-31T09:02:36.093Z" title="Created 2024-05-31 17:02:36">2024-05-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-21T17:50:37.065Z" title="Updated 2024-11-22 01:50:37">2024-11-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="IBM联合科研项目"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前置工作"><a href="#前置工作" class="headerlink" title="前置工作"></a>前置工作</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h3 id="Prometheus-Grafana"><a href="#Prometheus-Grafana" class="headerlink" title="Prometheus+Grafana"></a>Prometheus+Grafana</h3><p>环境：Ubuntu 22.04</p>
<ul>
<li>参考：<br>  <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8d2c020313f0">https://www.jianshu.com/p/8d2c020313f0</a><br>  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/crazymakercircle/p/16768535.html">https://www.cnblogs.com/crazymakercircle/p/16768535.html</a><br>  <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_31725371/article/details/114697770">https://blog.csdn.net/qq_31725371/article/details/114697770</a><h4 id="Prometheus-安装"><a href="#Prometheus-安装" class="headerlink" title="Prometheus 安装"></a>Prometheus 安装</h4><a target="_blank" rel="noopener" href="https://prometheus.io/download/">https://prometheus.io/download/</a><h4 id="Grafana-安装"><a href="#Grafana-安装" class="headerlink" title="Grafana 安装"></a>Grafana 安装</h4><a target="_blank" rel="noopener" href="https://grafana.com/grafana/download">https://grafana.com/grafana/download</a><h4 id="exporter-安装"><a href="#exporter-安装" class="headerlink" title="exporter 安装"></a>exporter 安装</h4></li>
<li>node_exporter为例<br>  <a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter/releases/tag/v1.8.0">https://github.com/prometheus/node_exporter/releases/tag/v1.8.0</a></li>
</ul>
<h4 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h4><p>如果Grafana是用docker安装的，prometheus是在本地环境中直接安装的话，添加数据源时，prometheus的地址不能直接填写<code>http://localhost:9090</code>，需要填写本机的ip地址，因为docker中的Grafana是一个独立的容器，localhost指的是容器内部的地址，而不是本机的地址。同理如果prometheus也是在docker中安装的，那么也需要填写docker的ip地址。</p>
<p>如果都安装在本地上，那么直接使用localhost:9090即可（Prometheus运行在9090，node_exporter 运行在9100，Grafana运行在3000）</p>
<h2 id="Prometheus使用"><a href="#Prometheus使用" class="headerlink" title="Prometheus使用"></a>Prometheus使用</h2><p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/351995351">https://zhuanlan.zhihu.com/p/351995351</a></p>
<h2 id="Grafana使用"><a href="#Grafana使用" class="headerlink" title="Grafana使用"></a>Grafana使用</h2><p>官方教程：<a target="_blank" rel="noopener" href="https://grafana.com/tutorials/?utm_source=grafana_gettingstarted">https://grafana.com/tutorials/?utm_source=grafana_gettingstarted</a></p>
<h1 id="每周学习-开发报告"><a href="#每周学习-开发报告" class="headerlink" title="每周学习/开发报告"></a>每周学习/开发报告</h1><h2 id="第一周"><a href="#第一周" class="headerlink" title="第一周"></a>第一周</h2><p>后端组：</p>
<ul>
<li>任务1 了解下什么是restful API。参考： <a target="_blank" rel="noopener" href="https://restfulapi.net/">https://restfulapi.net/</a></li>
<li>任务2 学习使用框架cherrypy，利用框架在本机完成一个helloworld的api接口。参考：<a target="_blank" rel="noopener" href="https://cherrypy.dev/">https://cherrypy.dev/</a></li>
<li>任务3 学习使用apidoc为自己的接口生成文档。参考：<a target="_blank" rel="noopener" href="https://apidocjs.com/">https://apidocjs.com/</a><h3 id="什么是restful-API"><a href="#什么是restful-API" class="headerlink" title="什么是restful API"></a>什么是restful API</h3>RESTful API 是一种设计风格，用于构建 Web 服务。REST 是 Representational State Transfer 的缩写，它是一种设计风格，用于构建 Web 服务。RESTful API 是基于 REST 架构设计的 API，它使用 HTTP 请求来进行通信，并遵循 REST 的设计原则。</li>
</ul>
<p>RESTful API 的设计原则包括以下几点：</p>
<ul>
<li>使用 HTTP 方法（GET、POST、PUT、DELETE）来操作资源。</li>
<li>使用 URL 来标识资源。</li>
<li>使用 JSON 或 XML 格式来传输数据。</li>
<li>使用状态码来表示请求的结果。</li>
</ul>
<p>RESTful API 的优点包括：</p>
<ul>
<li>简单：RESTful API 使用 HTTP 方法来操作资源，使得 API 的设计更加简单。</li>
<li>易于理解：RESTful API 使用 URL 来标识资源，使得 API 的使用更加直观。</li>
<li>易于扩展：RESTful API 使用 JSON 或 XML 格式来传输数据，使得 API 的扩展更加容易。</li>
<li>易于测试：RESTful API 使用状态码来表示请求的结果，使得 API 的测试更加简单。</li>
</ul>
<p>RESTful API 的缺点包括：</p>
<ul>
<li>缺乏标准：RESTful API 没有统一的标准，使得 API 的设计更加随意。</li>
<li>缺乏安全性：RESTful API 没有内置的安全机制，使得 API 的安全性更加脆弱。</li>
<li>缺乏性能：RESTful API 使用 HTTP 协议来通信，使得 API 的性能更加有限。<h3 id="cherrypy"><a href="#cherrypy" class="headerlink" title="cherrypy"></a>cherrypy</h3>官方仓库的tutorials：<a target="_blank" rel="noopener" href="https://github.com/cherrypy/cherrypy/blob/main/docs/tutorials.rst">https://github.com/cherrypy/cherrypy/blob/main/docs/tutorials.rst</a></li>
<li>安装  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install cherrypy</span><br></pre></td></tr></table></figure></li>
<li>示例代码  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloWorld</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line"></span><br><span class="line">cherrypy.quickstart(HelloWorld())</span><br></pre></td></tr></table></figure></li>
<li>运行  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python helloworld.py</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>cherrypy</code>是一个Python库，用于创建Web应用程序。它是一个最小主义的框架，提供了HTTP服务器和一个路由系统。</p>
<p>在helloworld.py中，<code>cherrypy</code>做了以下几件事：</p>
<ol>
<li><p>提供了一个装饰器<code>@cherrypy.expose</code>，这个装饰器用于将Python函数公开为Web应用程序的一部分。在你的代码中，<code>index</code>函数被公开，当用户访问应用程序的根URL（例如<code>http://localhost:8080/</code>）时，将调用此函数。</p>
</li>
<li><p>提供了一个函数<code>cherrypy.quickstart</code>，用于启动Web应用程序。在你的代码中，这个函数</p>
</li>
</ol>
<h4 id="用py编写一个简单的restful-API"><a href="#用py编写一个简单的restful-API" class="headerlink" title="用py编写一个简单的restful API"></a>用py编写一个简单的restful API</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api.py</span></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个图书类，用于模拟数据库中的数据</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, title, author, <span class="built_in">id</span>=<span class="literal">None</span></span>):</span><br><span class="line">        self.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">        self.title = title</span><br><span class="line">        self.author = author</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于检索图书的方法</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_book_by_id</span>(<span class="params">cls, <span class="built_in">id</span></span>):</span><br><span class="line">        <span class="comment"># 在实际应用中，这里会是查询数据库的地方</span></span><br><span class="line">        books = [book <span class="keyword">for</span> book <span class="keyword">in</span> ALL_BOOKS <span class="keyword">if</span> book.<span class="built_in">id</span> == <span class="built_in">id</span>]</span><br><span class="line">        <span class="keyword">return</span> books[<span class="number">0</span>] <span class="keyword">if</span> books <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于获取所有图书的方法</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_books</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">return</span> ALL_BOOKS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于添加图书的方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self</span>):</span><br><span class="line">        ALL_BOOKS.append(self)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于删除图书的方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self</span>):</span><br><span class="line">        ALL_BOOKS = [book <span class="keyword">for</span> book <span class="keyword">in</span> ALL_BOOKS <span class="keyword">if</span> book.<span class="built_in">id</span> != self.<span class="built_in">id</span>]</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟数据库中所有的图书记录</span></span><br><span class="line">ALL_BOOKS = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个RESTful API来处理图书信息的CRUD操作</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryAPI</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is a simple RESTful API for managing books.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line"><span class="meta">    @cherrypy.tools.json_out()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_books</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> Book.get_all_books()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line"><span class="meta">    @cherrypy.tools.json_in()</span></span><br><span class="line"><span class="meta">    @cherrypy.tools.json_out()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post_books</span>(<span class="params">self</span>):</span><br><span class="line">        book_data = cherrypy.request.json</span><br><span class="line">        new_book = Book(book_data[<span class="string">&#x27;title&#x27;</span>], book_data[<span class="string">&#x27;author&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> new_book.save()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line"><span class="meta">    @cherrypy.tools.json_in()</span></span><br><span class="line"><span class="meta">    @cherrypy.tools.json_out()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put_books</span>(<span class="params">self, <span class="built_in">id</span></span>):</span><br><span class="line">        book = Book.get_book_by_id(<span class="built_in">id</span>)</span><br><span class="line">        <span class="keyword">if</span> book <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> cherrypy.HTTPError(<span class="number">404</span>, <span class="string">&quot;Book not found&quot;</span>)</span><br><span class="line">        book_data = cherrypy.request.json</span><br><span class="line">        book.title = book_data[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        book.author = book_data[<span class="string">&#x27;author&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> book.save()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line"><span class="meta">    @cherrypy.tools.json_out()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_books</span>(<span class="params">self, <span class="built_in">id</span></span>):</span><br><span class="line">        book = Book.get_book_by_id(<span class="built_in">id</span>)</span><br><span class="line">        <span class="keyword">if</span> book <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> cherrypy.HTTPError(<span class="number">404</span>, <span class="string">&quot;Book not found&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> book.delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置CherryPy服务器</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cherrypy.config.update(&#123;<span class="string">&#x27;server.socket_host&#x27;</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;server.socket_port&#x27;</span>: <span class="number">8080</span>&#125;)</span><br><span class="line">    cherrypy.quickstart(LibraryAPI())</span><br></pre></td></tr></table></figure>
<p>这段代码创建了一个简单的RESTful API，包含以下端点：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">GET</span> /books：获取所有图书的信息。</span><br><span class="line"><span class="variable constant_">POST</span> /books：添加一本新书到数据库。</span><br><span class="line"><span class="variable constant_">PUT</span> /books/&lt;id&gt;：更新指定<span class="variable constant_">ID</span>的图书信息。</span><br><span class="line"><span class="variable constant_">DELETE</span> /books/&lt;id&gt;：删除指定<span class="variable constant_">ID</span>的图书。</span><br></pre></td></tr></table></figure>
<p>要运行这个API，只需要执行以下命令：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/books</span><br></pre></td></tr></table></figure></p>
<h4 id="tutorials"><a href="#tutorials" class="headerlink" title="tutorials"></a>tutorials</h4><h5 id="Tutorial-4-Submit-this-form"><a href="#Tutorial-4-Submit-this-form" class="headerlink" title="Tutorial 4: Submit this form"></a>Tutorial 4: Submit this form</h5><p>如何处理HTML表单<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StringGenerator</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;&lt;html&gt;</span></span><br><span class="line"><span class="string">          &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">          &lt;body&gt;</span></span><br><span class="line"><span class="string">            &lt;form method=&quot;get&quot; action=&quot;generate&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;input type=&quot;text&quot; value=&quot;8&quot; name=&quot;length&quot; /&gt;</span></span><br><span class="line"><span class="string">              &lt;button type=&quot;submit&quot;&gt;Give it now!&lt;/button&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;</span></span><br><span class="line"><span class="string">          &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, length=<span class="number">8</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(random.sample(string.hexdigits, <span class="built_in">int</span>(length)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cherrypy.quickstart(StringGenerator())</span><br></pre></td></tr></table></figure></p>
<h5 id="Tutorial-5-Track-my-end-user’s-activity"><a href="#Tutorial-5-Track-my-end-user’s-activity" class="headerlink" title="Tutorial 5: Track my end-user’s activity"></a>Tutorial 5: Track my end-user’s activity</h5><p>代码30-34展示了如何在CherryPy应用程序中启用会话支持。默认情况下，CherryPy将在进程的内存中保存会话。它还支持更持久的会话存储方式。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StringGenerator</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;&lt;html&gt;</span></span><br><span class="line"><span class="string">          &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">          &lt;body&gt;</span></span><br><span class="line"><span class="string">            &lt;form method=&quot;get&quot; action=&quot;generate&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;input type=&quot;text&quot; value=&quot;8&quot; name=&quot;length&quot; /&gt;</span></span><br><span class="line"><span class="string">              &lt;button type=&quot;submit&quot;&gt;Give it now!&lt;/button&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;</span></span><br><span class="line"><span class="string">          &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, length=<span class="number">8</span></span>):</span><br><span class="line">        some_string = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.hexdigits, <span class="built_in">int</span>(length)))</span><br><span class="line">        cherrypy.session[<span class="string">&#x27;mystring&#x27;</span>] = some_string</span><br><span class="line">        <span class="keyword">return</span> some_string</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> cherrypy.session[<span class="string">&#x27;mystring&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    conf = &#123;</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;tools.sessions.on&#x27;</span>: <span class="literal">True</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cherrypy.quickstart(StringGenerator(), <span class="string">&#x27;/&#x27;</span>, conf)</span><br></pre></td></tr></table></figure></p>
<h5 id="Tutorial-7-Give-us-a-REST"><a href="#Tutorial-7-Give-us-a-REST" class="headerlink" title="Tutorial 7: Give us a REST"></a>Tutorial 7: Give us a REST</h5><p>一个非常基本的遵循 REST 原则的 Web API 示例<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cherrypy.expose</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StringGeneratorWebService</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.tools.accept(<span class="params">media=<span class="string">&#x27;text/plain&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> cherrypy.session[<span class="string">&#x27;mystring&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">POST</span>(<span class="params">self, length=<span class="number">8</span></span>):</span><br><span class="line">        some_string = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.hexdigits, <span class="built_in">int</span>(length)))</span><br><span class="line">        cherrypy.session[<span class="string">&#x27;mystring&#x27;</span>] = some_string</span><br><span class="line">        <span class="keyword">return</span> some_string</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PUT</span>(<span class="params">self, another_string</span>):</span><br><span class="line">        cherrypy.session[<span class="string">&#x27;mystring&#x27;</span>] = another_string</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">DELETE</span>(<span class="params">self</span>):</span><br><span class="line">        cherrypy.session.pop(<span class="string">&#x27;mystring&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    conf = &#123;</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;request.dispatch&#x27;</span>: cherrypy.dispatch.MethodDispatcher(),</span><br><span class="line">            <span class="string">&#x27;tools.sessions.on&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;tools.response_headers.on&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;tools.response_headers.headers&#x27;</span>: [(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cherrypy.quickstart(StringGeneratorWebService(), <span class="string">&#x27;/&#x27;</span>, conf)</span><br></pre></td></tr></table></figure></p>
<p>We use the Session interface of requests so that it takes care of carrying the session id stored in the request cookie in each subsequent request. That is handy.<br>我们使用 requests 的 Session 接口，这样它会在每个后续请求中负责携带存储在请求 Cookie 中的会话 ID。这很方便。</p>
<p>使用python客户端进行web api测试，而不是浏览器。这是因为浏览器只支持GET和POST请求，而我们的API还支持PUT和DELETE请求。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; import requests</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; s = requests.Session()</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.get(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r.status_code</span></span><br><span class="line">500</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.post(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r.status_code, r.text</span></span><br><span class="line">(200, u&#x27;04A92138&#x27;)</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.get(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r.status_code, r.text</span></span><br><span class="line">(200, u&#x27;04A92138&#x27;)</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.get(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>, headers=&#123;<span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>&#125;)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r.status_code</span></span><br><span class="line">406</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.put(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>, params=&#123;<span class="string">&#x27;another_string&#x27;</span>: <span class="string">&#x27;hello&#x27;</span>&#125;)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.get(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r.status_code, r.text</span></span><br><span class="line">(200, u&#x27;hello&#x27;)</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.delete(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r = s.get(<span class="string">&#x27;http://127.0.0.1:8080/&#x27;</span>)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; r.status_code</span></span><br><span class="line">500</span><br></pre></td></tr></table></figure></p>
<h5 id="Tutorial-9-Data-is-all-my-life"><a href="#Tutorial-9-Data-is-all-my-life" class="headerlink" title="Tutorial 9: Data is all my life"></a>Tutorial 9: Data is all my life</h5><p>作为教程，为了简单起见，选择Python直接支持的数据库—— sqlite</p>
<blockquote>
<p>不幸的是，Python中的sqlite不允许我们在多线程之间共享连接。由于CherryPy是一个多线程服务器，因此这会成为一个问题。这就是为什么我们在每次调用时都会打开和关闭数据库连接的原因。这显然并不真正适合生产环境，最好还是使用更可靠的数据库引擎或更高级的库，如SQLAlchemy，以更好地满足应用程序的需求。</p>
</blockquote>
<p>我们的应用程序将把会话中生成的字符串存储到SQLite数据库中。该应用程序将具有与 tutorial 08 <tut08> 相同的HTML代码。因此，让我们仅关注应用程序本身的代码.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, os.path</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"></span><br><span class="line">DB_STRING = <span class="string">&quot;my.db&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StringGenerator</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;public\index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cherrypy.expose</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StringGeneratorWebService</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.tools.accept(<span class="params">media=<span class="string">&#x27;text/plain&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> sqlite3.connect(DB_STRING) <span class="keyword">as</span> c:</span><br><span class="line">            cherrypy.session[<span class="string">&#x27;ts&#x27;</span>] = time.time()</span><br><span class="line">            r = c.execute(<span class="string">&quot;SELECT value FROM user_string WHERE session_id=?&quot;</span>,</span><br><span class="line">                          [cherrypy.session.<span class="built_in">id</span>])</span><br><span class="line">            <span class="keyword">return</span> r.fetchone()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">POST</span>(<span class="params">self, length=<span class="number">8</span></span>):</span><br><span class="line">        some_string = <span class="string">&#x27;&#x27;</span>.join(random.sample(string.hexdigits, <span class="built_in">int</span>(length)))</span><br><span class="line">        <span class="keyword">with</span> sqlite3.connect(DB_STRING) <span class="keyword">as</span> c:</span><br><span class="line">            cherrypy.session[<span class="string">&#x27;ts&#x27;</span>] = time.time()</span><br><span class="line">            c.execute(<span class="string">&quot;INSERT INTO user_string VALUES (?, ?)&quot;</span>,</span><br><span class="line">                      [cherrypy.session.<span class="built_in">id</span>, some_string])</span><br><span class="line">        <span class="keyword">return</span> some_string</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PUT</span>(<span class="params">self, another_string</span>):</span><br><span class="line">        <span class="keyword">with</span> sqlite3.connect(DB_STRING) <span class="keyword">as</span> c:</span><br><span class="line">            cherrypy.session[<span class="string">&#x27;ts&#x27;</span>] = time.time()</span><br><span class="line">            c.execute(<span class="string">&quot;UPDATE user_string SET value=? WHERE session_id=?&quot;</span>,</span><br><span class="line">                      [another_string, cherrypy.session.<span class="built_in">id</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">DELETE</span>(<span class="params">self</span>):</span><br><span class="line">        cherrypy.session.pop(<span class="string">&#x27;ts&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">with</span> sqlite3.connect(DB_STRING) <span class="keyword">as</span> c:</span><br><span class="line">            c.execute(<span class="string">&quot;DELETE FROM user_string WHERE session_id=?&quot;</span>,</span><br><span class="line">                      [cherrypy.session.<span class="built_in">id</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_database</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Create the `user_string` table in the database</span></span><br><span class="line"><span class="string">    on server startup</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(DB_STRING) <span class="keyword">as</span> con:</span><br><span class="line">        con.execute(<span class="string">&quot;CREATE TABLE user_string (session_id, value)&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cleanup_database</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Destroy the `user_string` table from the database</span></span><br><span class="line"><span class="string">    on server shutdown.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(DB_STRING) <span class="keyword">as</span> con:</span><br><span class="line">        con.execute(<span class="string">&quot;DROP TABLE user_string&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    conf = &#123;</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;tools.sessions.on&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;tools.staticdir.root&#x27;</span>: os.path.abspath(os.getcwd())</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;/generator&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;request.dispatch&#x27;</span>: cherrypy.dispatch.MethodDispatcher(),</span><br><span class="line">            <span class="string">&#x27;tools.response_headers.on&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;tools.response_headers.headers&#x27;</span>: [(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;/static&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;tools.staticdir.on&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;tools.staticdir.dir&#x27;</span>: <span class="string">&#x27;./public&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cherrypy.engine.subscribe(<span class="string">&#x27;start&#x27;</span>, setup_database)</span><br><span class="line">    cherrypy.engine.subscribe(<span class="string">&#x27;stop&#x27;</span>, cleanup_database)</span><br><span class="line"></span><br><span class="line">    webapp = StringGenerator()</span><br><span class="line">    webapp.generator = StringGeneratorWebService()</span><br><span class="line">    cherrypy.quickstart(webapp, <span class="string">&#x27;/&#x27;</span>, conf)</span><br></pre></td></tr></table></figure></p>
<h5 id="Tutorial-11-Organize-my-code"><a href="#Tutorial-11-Organize-my-code" class="headerlink" title="Tutorial 11: Organize my code"></a>Tutorial 11: Organize my code</h5><p>CherryPy comes with a powerful architecture that helps you organizing your code in a way that should make it easier to maintain and more flexible.<br>CherryPy 提供了一个强大的架构，可以帮助您以一种更易于维护和更具灵活性的方式组织代码。</p>
<p>Several mechanisms are at your disposal, this tutorial will focus on the three main ones:<br>本教程将为您介绍几种可用的机制，重点介绍其中三种主要机制：</p>
<ul>
<li>dispatchers <dispatchers></li>
<li>tools <tools></li>
<li>plugins <busplugins></li>
</ul>
<h6 id="dispatchers"><a href="#dispatchers" class="headerlink" title="dispatchers"></a>dispatchers</h6><p>为了支持不同场景下需要设置一个收银台，也就是这些用例，CherryPy提供了一种称为“路由器（dispatcher）”的机制。路由器在请求处理过程中较早执行，以确定哪个代码片段将处理即将到来的请求。或者，继续使用商店的比喻，路由器将决定将顾客引导到哪个收银台。</p>
<h6 id="tools"><a href="#tools" class="headerlink" title="tools"></a>tools</h6><p>我们假设你的商店决定举办一次折扣促销活动，但仅针对特定类别的顾客。CherryPy可以通过一种名为“筛选器”（ tool <tools> ）的机制来处理此类用例。</p>
<p>A tool is a piece of code that runs on a per-request basis in order to perform additional work. Usually a tool is a simple Python function that is executed at a given point during the process of the request by CherryPy.<br>工具是一种在每个请求的基础上运行的代码，用于执行额外的工作。通常，工具是一个简单的Python函数，在请求处理过程中的某个特定点由CherryPy执行。</p>
<h6 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h6><p>In the CherryPy world, this translates into having functions that run outside of any request life-cycle. These functions should take care of background tasks, long lived connections (such as those to a database for instance), etc.<br>在CherryPy的世界中，这意味着需要一些在请求生命周期之外运行的函数。这些函数应该负责处理后台任务、长期连接（例如与数据库的连接）等。</p>
<p><code>Plugins &lt;busplugins&gt;</code> are called that way because they work along with the CherryPy <code>engine &lt;cpengine&gt;</code> and extend it with your operations.<br>它们之所以被称为“CherryPy扩展”，是因为它们与CherryPy框架协同工作，并通过添加自己的操作来扩展该框架。</p>
<h5 id="Tutorial-12-Using-pytest-and-code-coverage"><a href="#Tutorial-12-Using-pytest-and-code-coverage" class="headerlink" title="Tutorial 12: Using pytest and code coverage"></a>Tutorial 12: Using pytest and code coverage</h5><p>为以下程序编写测试程序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StringGenerator</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello world!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(random.sample(string.hexdigits, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:  <span class="comment"># pragma: no cover</span></span><br><span class="line">    cherrypy.quickstart(StringGenerator())</span><br></pre></td></tr></table></figure><br>测试程序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"><span class="keyword">from</span> cherrypy.test <span class="keyword">import</span> helper</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tut12 <span class="keyword">import</span> StringGenerator</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleCPTest</span>(helper.CPWebCase):</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_server</span>():</span><br><span class="line">        cherrypy.tree.mount(StringGenerator(), <span class="string">&#x27;/&#x27;</span>, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_index</span>(<span class="params">self</span>):</span><br><span class="line">        self.getPage(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">        self.assertStatus(<span class="string">&#x27;200 OK&#x27;</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_generate</span>(<span class="params">self</span>):</span><br><span class="line">        self.getPage(<span class="string">&quot;/generate&quot;</span>)</span><br><span class="line">        self.assertStatus(<span class="string">&#x27;200 OK&#x27;</span>)</span><br></pre></td></tr></table></figure><br>pytest：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest -v test_tut12.py</span><br></pre></td></tr></table></figure></p>
<p>pytest-cov：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest --cov=tut12 --cov-report term-missing test_tut12.py</span><br></pre></td></tr></table></figure><br>这两个命令都是用于运行Python的pytest测试框架的。</p>
<ol>
<li><p><code>pytest -v test_tut12.py</code>：这个命令用于运行名为<code>test_tut12.py</code>的测试文件。<code>-v</code>参数是<code>--verbose</code>的简写，它会使得pytest输出更详细的测试执行信息。</p>
</li>
<li><p><code>pytest --cov=tut12 --cov-report term-missing test_tut12.py</code>：这个命令使用了pytest的一个插件pytest-cov，用于计算测试覆盖率。<code>--cov=tut12</code>指定了要计算覆盖率的代码模块，这里是<code>tut12</code>模块。<code>--cov-report term-missing</code>指定了覆盖率报告的格式和输出方式，<code>term-missing</code>表示在终端输出报告，并列出未被测试覆盖的代码行。</p>
</li>
</ol>
<h3 id="APIDOC"><a href="#APIDOC" class="headerlink" title="APIDOC"></a>APIDOC</h3><ul>
<li>Install: <code>npm install apidoc -g</code></li>
<li>Run: <code>apidoc -i src -o apidoc</code><blockquote>
<p>Creates an apiDoc of all files within dir src, using the default template, and puts all output to apidoc directory.</p>
</blockquote>
</li>
</ul>
<p>在我们刚刚编写的RESTful API中，我们可以使用apidoc来生成API文档。</p>
<h3 id="关于可观测"><a href="#关于可观测" class="headerlink" title="关于可观测"></a>关于可观测</h3><p>可观测性包括 Metrics、Traces、Logs 3 个维度。可观测能力帮助我们在复杂的分布式系统中快速排查、定位问题，是分布式系统中必不可少的运维工具。</p>
<p>在性能压测领域中，可观测能力更为重要，除了有助于定位性能问题，其中Metrics性能指标更直接决定了压测是否通过，对系统上线有决定性左右，具体如下：</p>
<h4 id="Metrics，监控指标"><a href="#Metrics，监控指标" class="headerlink" title="Metrics，监控指标"></a>Metrics，监控指标</h4><p>系统性能指标，包括请求成功率、系统吞吐量、响应时长</p>
<p>资源性能指标，衡量系统软硬件资源使用情况，配合系统性能指标，观察系统资源水位</p>
<h4 id="Logs，日志"><a href="#Logs，日志" class="headerlink" title="Logs，日志"></a>Logs，日志</h4><p>施压引擎日志，观察施压引擎是否健康，压测脚本执行是否有报错</p>
<p>采样日志，采样记录 API 的请求和响应详情，辅助排查压测过程中的一些出错请求的参数是否正常，并通过响应详情，查看完整的错误信息</p>
<h4 id="Traces，追踪"><a href="#Traces，追踪" class="headerlink" title="Traces，追踪"></a>Traces，追踪</h4><p>分布式链路追踪用于性能问题诊断阶段，通过追踪请求在系统中的调用链路，</p>
<p>定位报错 API 的报错系统和报错堆栈，快速定位性能问题点</p>
<p>本篇阐述如何使用 Prometheus 实现性能压测 Metrics 的可观测性。</p>
<h3 id="下周目标"><a href="#下周目标" class="headerlink" title="下周目标"></a>下周目标</h3><ul>
<li>再次学习使用Prometheus+Grafana监控一个node并在grafana中展示</li>
<li>读LOP-API脚手架的源码</li>
<li>cherrypy + MariaDB</li>
<li>Linuxone基础知识入门<h2 id="第二周"><a href="#第二周" class="headerlink" title="第二周"></a>第二周</h2>前端组 后端组 ：<br>任务1 学习docker的基本用法，熟悉container，../image/image操作相关命令，使用一个简单的dockerfile build一个../image/image并启动。<br>任务2 搭建node_exporter+prometheus+grafana监控一个node并在grafana中展示，展示面板用这个就可以<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/1860-node-exporter-full/">https://grafana.com/grafana/dashboards/1860-node-exporter-full/</a> （每组合作完成一套环境搭建，最好在linux环境下完成）<br>任务3 进一步熟悉代码框架（后面对应指导老师会有专题讲座）<br>任务4 linuxone基础知识入门 （后面叶老师会有专题讲座，并有学习资料给到大家）<h3 id="在虚拟机上用docker拉取镜像"><a href="#在虚拟机上用docker拉取镜像" class="headerlink" title="在虚拟机上用docker拉取镜像"></a>在虚拟机上用docker拉取镜像</h3>由于之前是在Linux实体机上搭建了非dockers的Prometheus+Grafana环境，感觉不是很方便，但是在Windows环境上由于虚拟机的VT支持跟wsl2冲突了，我没法同时在Windows上用dockers以及在虚拟机里面搭建虚拟平台（某些课程和内核项目偶尔的需要），所以我打算直接在虚拟机里用dockers。所以这次我将在虚拟机Ubuntu22.04环境中用docker搭建Prometheus+Grafana环境。</li>
</ul>
<p>首先遇到了第一个问题：</p>
<ul>
<li>修改ssh配置，用vsc远程控制虚拟机</li>
<li>在虚拟机上用dockers拉取镜像的时候居然报错了！<blockquote>
<p>Error response from daemon: Get “<a target="_blank" rel="noopener" href="https://registry-1.docker.io/v2/">https://registry-1.docker.io/v2/</a>“: dial tcp: lookup registry-1.docker.io on 127.0.0.53:53: server misbehaving.</p>
</blockquote>
</li>
</ul>
<p>筛查了一下，发现是因为虚拟机的DNS设置有问题，一开始尝试修改了<code>/etc/dockers/daemon.json</code>，没有作用；后来的解决方法是修改<code>/etc/resolv.conf</code>文件，将<code>nameserver 127.0.0.53:53</code>改为<code>nameserver 8.8.8.8</code>（我也不知道为什么一开始是这个地址），然后重启网络服务<code>sudo service network-manager restart</code>再重新拉取镜像就可以了。</p>
<blockquote>
<p>小插曲，刚好在配置的这两天，国外的dockers hub被墙了，所以我还需要更换国内的镜像源。</p>
</blockquote>
<p>在<code>/etc/dockers/daemon.json</code>中更换docker hub的国内镜像，成功拉取<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://docker.mirrors.ustc.edu.cn/&quot;</span><span class="punctuation">,</span><span class="string">&quot;https://hub-mirror.c.163.com&quot;</span><span class="punctuation">,</span><span class="string">&quot;https://registry.docker-cn.com&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.0.0.12:5000&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="在Ubuntu上安装配置Maria-DB"><a href="#在Ubuntu上安装配置Maria-DB" class="headerlink" title="在Ubuntu上安装配置Maria DB"></a>在Ubuntu上安装配置Maria DB</h3><p>在 Ubuntu 上安装和配置 MariaDB 的步骤如下：</p>
<h4 id="步骤-1-安装-MariaDB"><a href="#步骤-1-安装-MariaDB" class="headerlink" title="步骤 1: 安装 MariaDB"></a>步骤 1: 安装 MariaDB</h4><ol>
<li><p><strong>更新包索引</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>安装 MariaDB 服务器</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mariadb-server</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="步骤-2-安全配置-MariaDB"><a href="#步骤-2-安全配置-MariaDB" class="headerlink" title="步骤 2: 安全配置 MariaDB"></a>步骤 2: 安全配置 MariaDB</h4><p>MariaDB 安装完成后，运行 <code>mysql_secure_installation</code> 脚本来设置 root 密码，移除匿名用户，禁止 root 用户远程登录，并删除测试数据库。</p>
<ol>
<li><p><strong>运行安全脚本</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure>
<p>按照提示操作：</p>
<ul>
<li>设置 root 密码。</li>
<li>移除匿名用户。</li>
<li>禁止 root 用户远程登录。</li>
<li>删除测试数据库并访问它。</li>
<li>重新加载权限表。</li>
</ul>
</li>
</ol>
<h4 id="步骤-3-配置-MariaDB-用户（可选）"><a href="#步骤-3-配置-MariaDB-用户（可选）" class="headerlink" title="步骤 3: 配置 MariaDB 用户（可选）"></a>步骤 3: 配置 MariaDB 用户（可选）</h4><p>为了更安全地操作数据库，建议创建一个新的数据库用户。</p>
<ol>
<li><p><strong>登录 MariaDB</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>创建新用户</strong>:<br>替换 <code>your_new_user</code> 和 <code>user_password</code> 为你的用户名和密码。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;your_new_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;user_password&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>授权新用户</strong>:<br>为用户授权，允许访问和操作数据库。替换 <code>database_name</code> 为你的数据库名。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> database_name.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;your_new_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>刷新权限</strong> 并 <strong>退出</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">EXIT;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="步骤-4-测试-MariaDB-安装"><a href="#步骤-4-测试-MariaDB-安装" class="headerlink" title="步骤 4: 测试 MariaDB 安装"></a>步骤 4: 测试 MariaDB 安装</h4><ol>
<li><p><strong>登录 MariaDB</strong>:<br>使用新创建的用户登录（如果已创建）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u your_new_user -p</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>查看 MariaDB 版本</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> version();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>完成以上步骤后，MariaDB 就安装并配置好了。你现在可以开始创建数据库和表，进行数据管理操作了。<br><img src="https://github.com/val213/val213.github.io/blob/hexo_source/source/_posts/../image/image-35.png?raw=true" alt="alt text"></p>
<h3 id="配置dockers环境过程中遇到启动了容器但是访问不到端口的问题"><a href="#配置dockers环境过程中遇到启动了容器但是访问不到端口的问题" class="headerlink" title="配置dockers环境过程中遇到启动了容器但是访问不到端口的问题"></a>配置dockers环境过程中遇到启动了容器但是访问不到端口的问题</h3><p>不管是虚拟机还是宿主机都访问不到。先说结论：重启docker服务……</p>
<p>尝试过程：<br>初步了解并排除了docker-compose.yml和prometheus.yml的问题。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val213@ubuntu:~$ curl 192.168.77.128:3000</span><br><span class="line">curl: (7) Failed to connect to 192.168.77.128 port 3000 after 21025 ms: Connection refused</span><br><span class="line"></span><br><span class="line">val213@ubuntu:~$ curl localhost:3000</span><br><span class="line">curl: (56) Recv failure: Connection reset by peer</span><br></pre></td></tr></table></figure></p>
<h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h4><p>这个文件是一个配置文件，用来定义和运行多容器的 Docker 应用程序。通过这个文件，可以使用 <code>docker-compose</code> 命令来启动、停止、删除多个容器，还可以一键启动多个容器。</p>
<p>docker-compose.yml文件是基于项目的，也就是说，每个项目都可以有一个对应的docker-compose.yml文件。这个文件通常放在项目的根目录下，用来定义项目的容器、网络、卷等信息。</p>
<h4 id="prometheus-yml"><a href="#prometheus-yml" class="headerlink" title="prometheus.yml"></a>prometheus.yml</h4><p>这个文件是 Prometheus 的配置文件，用来定义 Prometheus 的配置信息。通过这个文件，可以配置 Prometheus 的抓取规则、告警规则、存储配置等信息。</p>
<p><strong>启动 prometheus 容器的时候，使用-v参数将prometheus.yml文件挂载到容器内的/etc/prometheus目录下，这样 prometheus 就会读取这个配置文件。</strong></p>
<p>prometheus.yml文件是允许存在多个的，可以根据需要创建多个配置文件，然后在启动 prometheus 容器的时候指定不同的配置文件。</p>
<h4 id="docker-daemon-json"><a href="#docker-daemon-json" class="headerlink" title="docker/daemon.json"></a>docker/daemon.json</h4><p>这个是docker的配置文件，用来配置docker的一些参数，比如镜像加速器、日志配置等。我没有在这个文件中配置DNS，所以在排查问题的过程中，运行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val213@ubuntu:~$ docker exec -it a55d25c92e6f ping google.com</span><br><span class="line">ping: bad address &#x27;google.com&#x27;</span><br><span class="line">val213@ubuntu:~$ docker exec -it a55d25c92e6f ping baidu.com</span><br><span class="line">ping: bad address &#x27;baidu.com&#x27;</span><br><span class="line">val213@ubuntu:~$ docker exec -it a55d25c92e6f ping www.baidu.com</span><br><span class="line">ping: bad address &#x27;www.baidu.com&#x27;</span><br></pre></td></tr></table></figure><br>加上DNS:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://docker.mirrors.ustc.edu.cn/&quot;</span><span class="punctuation">,</span> <span class="string">&quot;https://hub-mirror.c.163.com&quot;</span><span class="punctuation">,</span> <span class="string">&quot;https://registry.docker-cn.com&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;10.0.0.12:5000&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span> <span class="string">&quot;8.8.4.4&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="内核级别的包过滤系统"><a href="#内核级别的包过滤系统" class="headerlink" title="内核级别的包过滤系统"></a>内核级别的包过滤系统</h4><p><code>sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT</code><br><code>sudo iptables -A INPUT -p tcp --dport 9090 -j ACCEPT</code><br>即使您没有主动使用防火墙软件，Linux系统中的<code>iptables</code>仍然是内核级别的包过滤系统，用于控制进出网络数据包的行为。<code>iptables</code>规则决定了如何处理经过网络接口的数据包。下面是对您提到的命令的解释：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p tcp --dport 9090 -j ACCEPT</span><br></pre></td></tr></table></figure>
<ul>
<li><code>iptables</code>: 调用iptables工具，它用于设置、查看和修改Linux内核的网络包过滤和NAT规则。</li>
<li><code>-A INPUT</code>: <code>-A</code>参数用于向指定链（这里是<code>INPUT</code>链）添加一条规则。<code>INPUT</code>链处理进入本机的数据包。</li>
<li><code>-p tcp</code>: 指定规则适用于TCP协议的数据包。<code>-p</code>参数用于指定数据包的协议类型。</li>
<li><code>--dport 9090</code>: 指定目的端口为9090。<code>--dport</code>参数用于匹配目的地端口号，这里表示规则只适用于目标端口为9090的数据包。</li>
<li><code>-j ACCEPT</code>: <code>-j</code>参数指定如果数据包匹配这条规则，应该采取的动作（”jump to”）。<code>ACCEPT</code>表示允许数据包通过，即不对符合条件的数据包进行任何阻止。</li>
</ul>
<p><strong>原理</strong>：</p>
<ul>
<li>当数据包到达您的系统时，<code>iptables</code>根据预设的规则来决定如何处理这些数据包。这些规则按照它们被添加到链中的顺序进行匹配。</li>
<li>如果一个进入的TCP数据包的目的端口是9090，这条规则会匹配该数据包，并允许它进入您的系统，而不是被丢弃或拒绝。</li>
<li>即使您没有主动配置或启用复杂的防火墙规则，<code>iptables</code>仍然在后台运行，根据其配置（包括默认规则和策略）处理网络流量。通过添加这条规则，您确保了所有尝试访问端口9090的TCP连接都不会被防火墙阻止。</li>
</ul>
<p>最终结果：虚拟机和宿主机都可以访问到Prometheus和Grafana的端口了！</p>
<h4 id="学到了其他的一些命令"><a href="#学到了其他的一些命令" class="headerlink" title="学到了其他的一些命令"></a>学到了其他的一些命令</h4><ul>
<li><code>docker inspect a55d25c92e6f</code>命令，可以查看容器的详细信息，包括网络配置等。</li>
<li><p>在Docker中，如果在启动容器时没有指定容器名称（<code>container_name</code>），Docker会自动生成一个随机的名称。这个名称通常由一个形容词和一个著名科学家或工程师的名字组成，例如<code>quizzical_ganguly</code>。</p>
<p>  然而，当使用<code>docker-compose</code>并在<code>docker-compose.yml</code>文件中为服务指定了<code>container_name</code>属性时，容器将使用这个指定的名称，而不是生成一个随机名称。例如<code>docker-compose.yml</code>文件片段中，Prometheus服务被明确命名为<code>prometheus</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">prometheus:</span><br><span class="line">    container_name: prometheus</span><br></pre></td></tr></table></figure>
<p>这意味着，当使用这个<code>docker-compose.yml</code>文件启动容器时，Prometheus容器的名称应该是<code>prometheus</code>，而不是一个随机生成的名称。如果容器名称是随机的，可能是因为容器是直接通过<code>docker run</code>命令启动的，而不是通过<code>docker-compose up</code>，或者是使用了不同的<code>docker-compose.yml</code>文件。</p>
<h4 id="真正的解决方法！"><a href="#真正的解决方法！" class="headerlink" title="真正的解决方法！"></a>真正的解决方法！</h4><p>以上都是虚假的解决方法，因为等我第二天重新打开访问端口的时候，又不行了！<br>我开始慢慢尝试之前试过的指令，最后发现，其实——真正的解决方法是重启docker服务！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<h3 id="node-exporter部署"><a href="#node-exporter部署" class="headerlink" title="node_exporter部署"></a>node_exporter部署</h3><p>node_exporter 是一个用于收集系统性能指标的代理，它会定期从系统中收集各种指标，并将这些指标暴露给 Prometheus。Prometheus 可以通过查询 node_exporter 来获取系统的性能指标，然后将这些指标存储在时间序列数据库中，以便后续分析和可视化。</p>
</li>
</ul>
<p>node_exporter 的部署有两种方式，一种是直接在系统上运行 node_exporter 二进制文件，另一种是使用 Docker 容器运行 node_exporter。在这里，我们将选择在宿主机上运行node_exporter二进制文件的方式。</p>
<p>推荐理由：</p>
<ul>
<li>优点:<ol>
<li>完整的系统指标：直接在宿主机上运行 Node Exporter 可以访问更多的系统指标，包括磁盘IO、网络状态、进程信息等。</li>
<li>简化网络配置：不需要特别配置网络，Prometheus 可以直接通过宿主机的网络访问Node Exporter。<h4 id="在宿主机上部署node-exporter"><a href="#在宿主机上部署node-exporter" class="headerlink" title="在宿主机上部署node_exporter"></a>在宿主机上部署node_exporter</h4></li>
</ol>
</li>
</ul>
<ol>
<li><p><strong>下载node_exporter二进制文件</strong>:<br>下载最新发行版，截止2024.6.10，最新版本是1.8.1。<br>要在宿主机上安装 Node Exporter，可以遵循以下步骤。这些步骤假设使用的是基于 Linux 的系统：</p>
</li>
<li><p><strong>下载Node Exporter</strong>:<br>首先，访问<a target="_blank" rel="noopener" href="https://prometheus.io/download/#node_exporter">Prometheus官方下载页面</a>以获取最新版本的Node Exporter。找到适合操作系统和架构的版本。以下命令示例将下载并解压Linux系统的最新版本（根据实际情况替换版本号）：</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v*/node_exporter-1.8.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"> tar -xvf node_exporter-1.8.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<ol>
<li><strong>安装Node Exporter</strong>:<br>解压后，将Node Exporter二进制文件移动到执行路径中：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> node_exporter-1.8.1.linux-amd64/node_exporter /usr/local/bin</span><br></pre></td></tr></table></figure>
<ol>
<li><p><strong>创建Systemd服务</strong>:<br>为了让Node Exporter作为服务运行，可以创建一个Systemd服务文件。这样可以方便地管理Node Exporter的启动、停止和自动重启。</p>
<p>创建一个新的Systemd服务文件：</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/node_exporter.service</span><br></pre></td></tr></table></figure>
<p>然后，将以下内容粘贴到文件中：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Node Exporter</span><br><span class="line"><span class="attr">Wants</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">User</span>=nobody</span><br><span class="line"><span class="attr">Group</span>=nogroup</span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/node_exporter</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p>保存并关闭文件。</p>
<ol>
<li><strong>启动Node Exporter服务</strong>:<br>重新加载Systemd以识别新的服务文件，启动Node Exporter服务，并设置为开机自启：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl start node_exporter</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> node_exporter</span><br></pre></td></tr></table></figure>
<ol>
<li><strong>验证Node Exporter运行情况</strong>:<br>检查Node Exporter服务的状态，确保它正在运行：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status node_exporter</span><br></pre></td></tr></table></figure>
<p>也可以通过访问<code>http://&lt;宿主机IP地址&gt;:9100/metrics</code>在浏览器中查看Node Exporter暴露的指标，以验证它是否正确运行。</p>
<p>完成以上步骤后，Node Exporter将在宿主机上作为服务运行，Prometheus可以配置为从这个端点抓取指标。</p>
<h5 id="关于Prometheus访问不到node-exporter的问题"><a href="#关于Prometheus访问不到node-exporter的问题" class="headerlink" title="关于Prometheus访问不到node_exporter的问题"></a>关于Prometheus访问不到node_exporter的问题</h5><p>问题描述：在Prometheus配置文件中添加了node_exporter的target，但是在Prometheus的web界面中无法访问到node_exporter的指标。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node_exporter&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;node_exporter:9100&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;mariaDB&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9104&#x27;</span>]</span><br></pre></td></tr></table></figure><br>这两个target都是down，并且报错：<code>Get &quot;http://localhost:9104/metrics&quot;: dial tcp 127.0.0.1:9104: connect: connection refused</code>和<code>Get &quot;http://node_exporter:9100/metrics&quot;: dial tcp: lookup node_exporter on 8.8.8.8:53: no such host</code><br><strong>因为我是在虚拟机中部署node_exporter的</strong>，所以得修改<code>prometheus.yml</code>文件，把<code>target</code>的IP地址改为虚拟机的IP地址(不能是<code>localhost</code>或者<code>node_exporter</code>，后者应该是在哪个教程粘贴的时候没注意，这玩意DNS根本解析不了)。同时要注意yml文件的格式，冒号后面要有空格。不然就会一启动容器就自动退出到<code>EXIT</code>状态。</p>
<h5 id="tips："><a href="#tips：" class="headerlink" title="tips："></a>tips：</h5><ul>
<li>创建容器的时候用 <code>--name</code> 指定名字<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name=prometheus_new \</span><br><span class="line">  -p 9090:9090 \</span><br><span class="line">  -v /home/val213/LOP-learn/prometheus.yml:/etc/prometheus/prometheus.yml \</span><br><span class="line">  prom/prometheus</span><br></pre></td></tr></table></figure></li>
<li>查看容器的日志<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs &lt;container_id/name&gt;</span><br></pre></td></tr></table></figure></li>
<li>重启prometheus容器<ul>
<li>如果修改了Prometheus的配置文件（prometheus.yml）并希望应用这些更改，那么在这种情况下，需要重新加载Prometheus的配置或重启Prometheus容器。Prometheus支持在不重启的情况下重新加载其配置，可以通过发送SIGHUP信号到Prometheus进程来实现：</li>
<li><code>docker kill --signal=SIGHUP prometheus_new</code></li>
<li>这将指示Prometheus重新加载其配置文件(注意这里的<code>prometheus_new</code>是我的容器的名字，你得换成你自己的)。如果出于某种原因这不起作用，或者您更倾向于简单的方法，您可以安全地重启Prometheus容器：</li>
<li><code>docker restart prometheus_new</code></li>
<li>重启后，Prometheus将使用最新的配置启动，包括任何对抓取目标的更改。<h3 id="Grafana展示面板"><a href="#Grafana展示面板" class="headerlink" title="Grafana展示面板"></a>Grafana展示面板</h3>当Grafana和Prometheus都在容器中运行时，您可以通过以下步骤为Grafana添加Prometheus作为数据源：</li>
</ul>
</li>
</ul>
<h4 id="步骤1-确定-Prometheus-容器的网络访问地址"><a href="#步骤1-确定-Prometheus-容器的网络访问地址" class="headerlink" title="步骤1: 确定 Prometheus 容器的网络访问地址"></a>步骤1: 确定 Prometheus 容器的网络访问地址</h4><p>确定Prometheus容器的网络访问地址，因为Grafana需要通过这个地址来访问Prometheus。如果Grafana和Prometheus在同一个Docker网络中，您可以使用容器名称作为目标地址。确保两个容器都连接到同一个自定义网络（而不是默认的<code>bridge</code>网络），这样它们就可以通过容器名称相互访问了。</p>
<p>如果您还没有创建自定义网络，可以通过以下命令创建一个：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create my-monitoring-network</span><br></pre></td></tr></table></figure>
<p>然后，确保启动Prometheus和Grafana容器时将它们连接到这个网络。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --network=my-monitoring-network \</span><br><span class="line">  --name=prometheus_new \</span><br><span class="line">  -p 9090:9090 \</span><br><span class="line">  -v /home/val213/LOP-learn/prometheus.yml:/etc/prometheus/prometheus.yml \</span><br><span class="line">  prom/prometheus</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --network=my-monitoring-network \</span><br><span class="line">  --name=grafana_new \</span><br><span class="line">  -p 3000:3000 \</span><br><span class="line">  grafana/grafana</span><br></pre></td></tr></table></figure>
<h4 id="步骤2-为-Grafana-添加-Prometheus-数据源"><a href="#步骤2-为-Grafana-添加-Prometheus-数据源" class="headerlink" title="步骤2: 为 Grafana 添加 Prometheus 数据源"></a>步骤2: 为 Grafana 添加 Prometheus 数据源</h4><ol>
<li><p><strong>登录到Grafana</strong>：在浏览器中打开Grafana的UI（默认是<code>http://localhost:3000</code>），使用默认的<code>admin/admin</code>作为用户名和密码登录。</p>
</li>
<li><p><strong>打开数据源设置</strong>：登录后，点击左侧菜单栏的齿轮图标（设置），然后选择“Data Sources”。</p>
</li>
<li><p><strong>添加数据源</strong>：点击页面上的“Add data source”按钮，然后从列表中选择“Prometheus”。</p>
</li>
<li><p><strong>配置 Prometheus 数据源</strong>：</p>
<ul>
<li>在“HTTP”部分的“URL”字段中，输入Prometheus的访问地址。如果Grafana和Prometheus在同一个Docker网络中，这将是<code>http://prometheus:9090</code>，其中<code>prometheus</code>是Prometheus容器的名称，<code>9090</code>是Prometheus默认的端口号。</li>
<li>其他设置可以保留默认值。</li>
</ul>
</li>
<li><p><strong>保存并测试</strong>：点击页面底部的“Save &amp; Test”按钮。Grafana将尝试连接到指定的Prometheus实例。如果配置正确，您将看到一个绿色的成功消息。</p>
</li>
</ol>
<p>完成这些步骤后，您就成功地将Prometheus添加为Grafana的数据源了，现在可以开始创建仪表板来可视化Prometheus收集的指标数据。</p>
<h3 id="尝试监控MariaDB"><a href="#尝试监控MariaDB" class="headerlink" title="尝试监控MariaDB"></a>尝试监控MariaDB</h3><p>要在Prometheus中监控MariaDB，您可以使用<code>mysqld_exporter</code>，这是一个官方的exporter，用于抓取MySQL和MariaDB服务器的指标并使其可供Prometheus监控。以下是配置过程的概述：</p>
<h4 id="步骤1-下载并安装mysqld-exporter"><a href="#步骤1-下载并安装mysqld-exporter" class="headerlink" title="步骤1: 下载并安装mysqld_exporter"></a>步骤1: 下载并安装<code>mysqld_exporter</code></h4><ol>
<li>访问<a target="_blank" rel="noopener" href="https://github.com/prometheus/mysqld_exporter/releases">mysqld_exporter的GitHub发布页面</a>下载最新版本的<code>mysqld_exporter</code>。</li>
<li>解压下载的文件到合适的目录。</li>
<li><p>赋予<code>mysqld_exporter</code>可执行权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x mysqld_exporter</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="步骤2-配置-MariaDB-访问权限"><a href="#步骤2-配置-MariaDB-访问权限" class="headerlink" title="步骤2: 配置 MariaDB 访问权限"></a>步骤2: 配置 MariaDB 访问权限</h4><p>为了让<code>mysqld_exporter</code>能够访问MariaDB的指标，您需要为其创建一个具有限制权限的用户。</p>
<ol>
<li><p>登录到MariaDB：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个新用户并授予必要的权限：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;exporter&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;YourPassword&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> PROCESS, SLAVE MONITOR, REPLICATION CLIENT,  <span class="keyword">SELECT</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;exporter&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<p>替换<code>YourPassword</code>为您选择的密码。</p>
</li>
</ol>
<h4 id="步骤3-配置mysqld-exporter"><a href="#步骤3-配置mysqld-exporter" class="headerlink" title="步骤3: 配置mysqld_exporter"></a>步骤3: 配置<code>mysqld_exporter</code></h4><ol>
<li>创建一个名为<code>.my.cnf</code>的配置文件，包含用于登录MariaDB的凭据：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">user=exporter</span><br><span class="line">password=YourPassword</span><br></pre></td></tr></table></figure>
<ol>
<li>确保此文件的权限足够安全，仅<code>mysqld_exporter</code>和必要的管理员用户可读。</li>
</ol>
<h4 id="步骤4-运行mysqld-exporter"><a href="#步骤4-运行mysqld-exporter" class="headerlink" title="步骤4: 运行mysqld_exporter"></a>步骤4: 运行<code>mysqld_exporter</code></h4><p>使用以下命令启动<code>mysqld_exporter</code>，并指定配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mysqld_exporter --config.my-cnf=&quot;/home/val213/LOP-learn/.my.cnf&quot;</span><br></pre></td></tr></table></figure>
<h4 id="步骤5-配置-Prometheus-监控-mysqld-exporter"><a href="#步骤5-配置-Prometheus-监控-mysqld-exporter" class="headerlink" title="步骤5: 配置 Prometheus 监控 mysqld_exporter"></a>步骤5: 配置 Prometheus 监控 <code>mysqld_exporter</code></h4><ol>
<li><p>编辑Prometheus的配置文件<code>prometheus.yml</code>，添加<code>mysqld_exporter</code>作为一个抓取目标：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9104&#x27;</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启Prometheus以应用新的配置。</p>
</li>
</ol>
<h4 id="步骤6-在Grafana中创建仪表板"><a href="#步骤6-在Grafana中创建仪表板" class="headerlink" title="步骤6: 在Grafana中创建仪表板"></a>步骤6: 在Grafana中创建仪表板</h4><p>略去这一步，但是记得node_exporter_full是看不到mysql的监控的，要换一个支持mysql的监控仪表板。例如<code>https://grafana.com/grafana/dashboards/13106-galera-mariadb-overview/</code>。</p>
<h3 id="任务三-研读LOP-API脚手架的源码"><a href="#任务三-研读LOP-API脚手架的源码" class="headerlink" title="任务三 研读LOP-API脚手架的源码"></a>任务三 研读LOP-API脚手架的源码</h3><h3 id="任务四-Linuxone-基础知识入门"><a href="#任务四-Linuxone-基础知识入门" class="headerlink" title="任务四 Linuxone 基础知识入门"></a>任务四 Linuxone 基础知识入门</h3><blockquote>
<p>IBM LinuxONE is an enterprise-grade Linux® server that brings together the IBM expertise in building enterprise systems with the openness of the Linux operating system.<br>IBM LinuxONE是一款企业级Linux®服务器，它将IBM在构建企业级系统方面的专业知识与Linux操作系统的开放性结合在一起。</p>
<p>LinuxONE offers a sustainable and cyber-resilient platform for hybrid cloud and AI applications, which can also help reduce total cost of ownership through workload consolidation.<br>LinuxONE提供了一个可持续且具备网络弹性的平台，可用于混合云和AI应用程序，通过工作负载整合，还可以帮助降低总体拥有成本。</p>
</blockquote>
<h2 id="Linuxone基础知识讲座"><a href="#Linuxone基础知识讲座" class="headerlink" title="Linuxone基础知识讲座"></a>Linuxone基础知识讲座</h2><h3 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h3><h4 id="什么是Linuxone"><a href="#什么是Linuxone" class="headerlink" title="什么是Linuxone"></a>什么是Linuxone</h4><p><img src="../image/image-325.png" alt="alt text"></p>
<h4 id="发展历史"><a href="#发展历史" class="headerlink" title="发展历史"></a>发展历史</h4><p><img src="../image/image-326.png" alt="alt text"></p>
<h4 id="Rockhopper-Ⅱ-and-Emperor-Ⅱ"><a href="#Rockhopper-Ⅱ-and-Emperor-Ⅱ" class="headerlink" title="Rockhopper Ⅱ and Emperor Ⅱ"></a>Rockhopper Ⅱ and Emperor Ⅱ</h4><p><img src="../image/image-327.png" alt="alt text"></p>
<h4 id="IBM-z14-frame-layout"><a href="#IBM-z14-frame-layout" class="headerlink" title="IBM z14 frame layout"></a>IBM z14 frame layout</h4><p><img src="../image/image-312.png" alt="alt text"></p>
<ul>
<li>ibmZ<strong>不提供磁盘</strong> <h3 id="DPM-Dynamic-Partition-Manager"><a href="#DPM-Dynamic-Partition-Manager" class="headerlink" title="DPM (Dynamic Partition Manager)"></a>DPM (Dynamic Partition Manager)</h3><img src="../image/image-313.png" alt="alt text"></li>
<li>资源管理工具，降低了解门槛<br><img src="../image/image-314.png" alt="alt text"><h4 id="process-and-memory"><a href="#process-and-memory" class="headerlink" title="process and memory"></a>process and memory</h4></li>
<li>划分逻辑资源LPAR<br><img src="../image/image-315.png" alt="alt text"></li>
<li>双柜可以分80个分区<br><img src="../image/image-316.png" alt="alt text"><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><img src="../image/image-317.png" alt="alt text"></li>
<li>shared：一个CPU被多个分区共享</li>
<li>dedicated：一个CPU被一个分区独占</li>
<li>频分比：一个CPU被多个分区共享时，每个分区的CPU时间比例<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><img src="../image/image-318.png" alt="alt text"></li>
<li>计划任务<h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><img src="../image/image-319.png" alt="alt text"></li>
<li>Linux one不提供磁盘，存储来自于外部存储</li>
<li>通过光纤交换机看到存储</li>
<li>path：注意到路径的变化情况，说明了一些可能原因</li>
<li>存储类型<ul>
<li>boot 用来装OS</li>
<li>data 用来装数据，不能装OS</li>
</ul>
</li>
<li>Storage Group<ul>
<li>单个存储是storage volume，一个或者多个storage volume集合成group</li>
<li>每个SG可以同时map到多个area part，也可以只map到一个area part</li>
</ul>
</li>
<li>FCP 光纤通道协议<ul>
<li>WWPN</li>
<li>世界范围唯一的光纤通道地址</li>
<li>类比MAC地址</li>
</ul>
</li>
<li>VHBA<ul>
<li>虚拟HBA</li>
<li>需要交换机支持</li>
<li>把网卡虚拟出多个网卡</li>
<li>用来连接存储<h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><img src="../image/image-320.png" alt="alt text"></li>
</ul>
</li>
<li>10GB的卡叫OSD：Open System Adapter</li>
<li>25GB的卡叫RoCE：<br>同样可以划分逻辑资源，例如：</li>
<li>05的卡被以下的partition共享：<br><img src="../image/image-321.png" alt="alt text"></li>
<li>17的卡被以下的partition独占：<br><img src="../image/image-322.png" alt="alt text"><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><img src="../image/image-323.png" alt="alt text"><br><img src="../image/image-324.png" alt="alt text"></li>
</ul>
<h2 id="第三周考试周"><a href="#第三周考试周" class="headerlink" title="第三周考试周"></a>第三周考试周</h2><p>搭建本地API测试server<br><img src="../image/image-328.png" alt="alt text"><br>途中遇到了几个问题：</p>
<ol>
<li><code>./local_test.sh init</code> 的时候，遇到报错<br> <img src="../image/image-329.png" alt="alt text"><ul>
<li>解决方法：<br>查阅资料<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/62473932/at-least-one-invalid-signature-was-encountered">stackoverflow: At least one invalid signature was encountered
</a>后进行尝试和排查，发现应该是磁盘空间不足了，进行虚拟机磁盘扩容</li>
</ul>
</li>
<li>扩容后虚拟机启动不起来了：原因是因为虚拟机的磁盘扩容后，虚拟机的分区表没有更新，所以虚拟机无法识别新的磁盘空间。<ul>
<li>解决方法：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Alan_Walker688/article/details/131889313">VMWare中给Ubuntu 虚拟机硬盘扩容后无法正常开机的相关问题</a></li>
</ul>
</li>
<li>启动之后网络不通，ens33网卡状态异常。连不到dockerhub，vscode也ssh不到<ul>
<li>解决方法：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41969790/article/details/103222251">Ubuntu上不了网：ifconfig查看只有lo,没有ens33问题解决参考方法</a></li>
</ul>
</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/White_lies/article/details/124093530">vscode连接不上问题和解决方法合集</a><br>后来又遇到过一次 <code>Got error from ssh: spawn C:\Windows\System32\WindowsPowerShell\v1.0\ssh.exe ENOENT</code><br><img src="../image/image-360.png" alt="alt text"></p>
<h2 id="第四周"><a href="#第四周" class="headerlink" title="第四周"></a>第四周</h2><p>任务分配： <a target="_blank" rel="noopener" href="https://github.com/JasonCrash/LOP-API/issues/4">https://github.com/JasonCrash/LOP-API/issues/4</a></p>
</blockquote>
<h3 id="什么是-zhmc-prometheus-exporter"><a href="#什么是-zhmc-prometheus-exporter" class="headerlink" title="什么是 zhmc-prometheus-exporter ?"></a>什么是 <code>zhmc-prometheus-exporter</code> ?</h3><p>HMC：硬件管理控制台</p>
<p><code>zhmc-prometheus-exporter</code> 包含了 <code>zhmcclient</code> 作为其依赖库。它在内部使用 <code>zhmcclient</code> 的 API 来与 HMC 进行交互，并定期调用这些 API 获取最新的监控数据。</p>
<p><code>zhmc-prometheus-exporter</code> 支持ZHMC提供的所有指标以及一些基于HMC资源属性（如LPAR的内存或CPU权重）的有用指标。基于资源属性的指标在后台通过HMC发出的更改通知以及不支持更改通知的属性的异步检索获得。</p>
<p><a target="_blank" rel="noopener" href="https://zhmc-prometheus-exporter.readthedocs.io/en/stable/usage.html#available-metrics">available-metrics</a></p>
<p>The following table shows the mapping between  <code>exporter metric groups</code> and <code>exported Prometheus metrics</code> in <code>the standard metric definition</code>. 请注意，集合和 zBX 相关的度量不在标准度量定义范围内（z15 版本已移除了对它们的支持）。有关 HMC 度量的更多信息，请参见 HMC API 手册中的“度量组”部分。有关 CPC 和分区（DPM 模式）以及逻辑分区（经典模式）的资源属性的更多信息，请参见 HMC API 手册中的相应数据模型。</p>
<p><img src="../image/image-357.png" alt="alt text"></p>
<p>Legend:</p>
<ul>
<li>Type: The type of the metric group: M=metric service, R=resource property<br>类型：度量组的类型：M=度量服务，R=资源属性</li>
<li>Mode: The operational mode of the CPC: C=Classic, D=DPM<br>模式：CPC的操作模式：C=经典模式，D=DPM模式</li>
</ul>
<p>As you can see, the <code>zhmc_cpc_*</code> and <code>zhmc_partition_*</code> metrics are used for both <code>DPM mode</code> and <code>classic</code> mode. The names of the metrics are equal if and only if they have the same meaning in both modes.</p>
<ul>
<li>hmccreds.yaml<blockquote>
<p>Provide an HMC credentials file for use by the exporter.<br>为exporter提供一个HMC证书文件。<br>The HMC credentials file tells the exporter which HMC to talk to for obtaining metrics, and which userid and password to use for logging on to the HMC.<br>HMC 认证文件告诉exporter要与哪个 HMC 进行通信以获取指标，以及要使用哪个用户 ID 和密码登录到 HMC。<br>It also defines whether HTTP or HTTPS is used for Prometheus, and HTTPS related certificates and keys.<br>它还定义了Prometheus使用的是HTTP还是HTTPS，以及与HTTPS相关的证书和密钥。<br>Download the Sample HMC credentials file as hmccreds.yaml and edit that copy accordingly.<br>下载 Sample HMC 凭据文件，然后根据需要进行编辑。<br>For details, see HMC credentials file.<br>详细信息请参见HMC凭据文件。</p>
</blockquote>
</li>
</ul>
<ul>
<li>matrics.yaml<blockquote>
<p>Provide a metric definition file for use by the exporter.<br>为 exporter 提供一个度量定义文件。<br>The metric definition file maps the metrics returned by the HMC to metrics exported to Prometheus.<br>度量定义文件将HMC返回的度量映射到Prometheus可导出的度量。<br>Furthermore, the metric definition file allows optimizing the access time to the HMC by disabling the fetching of metrics that are not needed.<br>此外，度量定义文件允许通过禁用不需要的度量来优化对HMC的访问时间。<br>Download the Sample metric definition file as metrics.yaml. It can be used as it is and will have all metrics enabled and mapped properly. You only need to edit the file if you want to adjust the metric names, labels, or metric descriptions, or if you want to optimize access time by disabling metrics not needed.<br>下载示例度量定义文件，将其保存为。该文件可以直接使用，并且会启用所有度量并正确映射。如果您想更改度量名称、标签或描述，或者想通过禁用不需要的度量来优化访问时间，只需编辑该文件即可。<br>For details, see Metric definition file.<br>详细信息请参见度量定义文件。</p>
</blockquote>
</li>
</ul>
<p><strong>在这个文件中，exporter_name 是用来标识每个度量指标（metric）的唯一名称，它代表了特定的监控数据点。这些名称通常用于 Prometheus 配置中，以便于 Prometheus 识别和收集相应的指标数据。</strong></p>
<h3 id="Demo-setup-with-Grafana"><a href="#Demo-setup-with-Grafana" class="headerlink" title="Demo setup with Grafana"></a>Demo setup with Grafana</h3><p>部署图<br><img src="../image/image-356.png" alt="alt text"></p>
<h3 id="prometheus-metrics类型"><a href="#prometheus-metrics类型" class="headerlink" title="prometheus metrics类型"></a>prometheus metrics类型</h3><p><img src="../image/image-358.png" alt="alt text"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Metric 类型</th>
<th>说明</th>
<th>常用指标</th>
</tr>
</thead>
<tbody>
<tr>
<td>Counter</td>
<td>Counter 类型的指标和计数器一样，只增不减（除非系统发生重置）。常见的监控指标，例如http_requests_total，node_cpu_seconds_total 都是 Counter 类型的监控指标。Counter 类型的指标名称常使用 _total 作为后缀。Counter 是一个简单但强大的指标，但需要明确的是，某项指标的累计值，对于用户了解系统状态来说，没什么直接的价值。因此，Counter 指标常搭配 rate 或 increase 函数，通过取 范围向量（range vector） 来使用。</td>
<td>CPU 使用时间，网络流量，请求量</td>
</tr>
<tr>
<td>Gauge</td>
<td>与 Counter 类型不同，Gauge 类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。例如 node_memory_MemFree_bytes（主机当前空闲的内存大小）、container_memory_usage_bytes （容器当前内存大小）都是 Gauge 类型的监控指标。</td>
<td>内存用量，硬盘空间，服务运行状态</td>
</tr>
<tr>
<td>Histogram</td>
<td>Counter 指标存在一个问题：它只能被计算为均值。而对于类似 接口请求延迟 类的数据，仅仅有平均值还不够。还需要看到数据的分布情况，甚至计算百分位数（quantile）。对于这类数据，Prometheus 提供了 2 种指标类型：histogram 和 Summary。其中，Histogram 的原理是提前定义多个buckets，覆盖所有可能的样本；采集到新样本时，这个样本会落入某个 bucket 内。使用时，我们可以利用样本在各个 bucket 的分布情况计算 quantile。展示时，histogram 尤其适合绘制火焰图（heat map）。</td>
<td>各类延迟、耗时类指标</td>
</tr>
<tr>
<td>Summary</td>
<td>Summary 与 Histogram 一样，可以用来查看数据的分布情况。但与 Histogram 不同的是，Summary 返回的是计算后数据（中位数的具体值）。因此，它相比 Histogram 省略了在查询时的计算消耗，但是也丢失了原始的样本数据。</td>
<td>各类延迟、耗时类指标</td>
</tr>
</tbody>
</table>
</div>
<h3 id="核心指标"><a href="#核心指标" class="headerlink" title="核心指标"></a>核心指标</h3><p>zhmc-prometheus-exporter 的核心指标是什么？</p>
<h4 id="整理概念"><a href="#整理概念" class="headerlink" title="整理概念"></a>整理概念</h4><p>首先理清楚几个概念和文件之间的关系。</p>
<p><code>metrics.yaml</code> 里定义了一批 <strong>metrics group</strong> 和对应的 <strong>metrics</strong>，metrics group 是一组相关的 metrics，metrics 是具体的指标，比如 <code>zhmc_cpc_processor_usage_ratio</code> 是一个metrics，属于 <code>cpc-usage-overview</code> 这个 metrics group。在 <code>metrics.yaml</code> 文件中，定义了 metrics group 和 metrics 之间的关系，以及 metrics 的一些属性，比如是否启用、是否需要计算、是否需要计算rate等。其中有一个属性是<code>exporter_name</code>，这个属性是用来标识每个度量指标（metric）的唯一名称，它代表了特定的监控数据点。这些名称通常用于 Prometheus 配置中，以便于 Prometheus 识别和收集相应的指标数据。可以通过 metrics group 和 exporter_name 来唯一确定 <strong>mapping</strong> 到的具体的 Prometheus metrics。</p>
<p>参考前端同学的用到的部分Prometheus Metrics：</p>
<ul>
<li>zhmc_cpc_processor_usage_ratio: Usage ratio across all processors of the CPC</li>
<li>zhmc_cpc_network_adapter_usage_ratio</li>
<li>zhmc_cpc_storage_adapter_usage_ratio</li>
<li>zhmc_partition_processor_usage_ratio</li>
<li>zhmc_partition_network_adapter_usage_ratio</li>
<li>zhmc_partition_storage_adapter_usage_ratio</li>
</ul>
<h3 id="investigate-how-to-get-network-usage-through-zhmc-exporter"><a href="#investigate-how-to-get-network-usage-through-zhmc-exporter" class="headerlink" title="investigate how to get network usage through zhmc exporter"></a>investigate how to get network usage through zhmc exporter</h3><p><img src="../image/image-359.png" alt="alt text"></p>
<p>CPC（Central Processing Complex）可以看作是一台机器，其中划分了多个分区（partitions）。每个分区可能会连接一个或多个网络接口控制器（NIC），这些NIC可以理解为虚拟网卡。每个NIC又对应一个网络适配器（Adapter），其名称可能类似于OSD 010CA01B-05，而这个OSD 010CA01B-05实际上就是一块实际的物理网卡。</p>
<p>我们目前的目标是实现以下效果：首先，获取一个网络适配器的使用量。如果这个网络适配器被多个分区共享，我们需要知道该适配器的总使用量，并且明确各个分区在总使用量中分别占据的份额。</p>
<p>首先看看有哪些相关的metrics：</p>
<ul>
<li><p><code>zhmc_cpc_network_adapter_usage_ratio</code>: Usage ratio across all network adapters of the CPC. CPC 所有网络适配器的使用率。</p>
</li>
<li><p><code>zhmc_partition_network_adapter_usage_ratio</code>: Usage ratio of all network adapters of the partition. 该分区所有网卡的使用率。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">partition-usage:</span></span><br><span class="line">    <span class="attr">network-usage:</span></span><br><span class="line">        <span class="attr">percent:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">exporter_name:</span> <span class="string">network_adapter_usage_ratio</span></span><br><span class="line">        <span class="attr">exporter_desc:</span> <span class="string">Usage</span> <span class="string">ratio</span> <span class="string">of</span> <span class="string">all</span> <span class="string">network</span> <span class="string">adapters</span> <span class="string">of</span> <span class="string">the</span> <span class="string">partition</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>partition-attached-network-interface</code> : 分区附加网络接口</p>
<ul>
<li>zhmc_nic_bytes_sent_count 已发送的单播数据包的字节数</li>
<li>zhmc_nic_bytes_received_count 已接收的单播数据包的字节数</li>
<li>zhmc_nic_packets_sent_count 已发送的单播数据包数</li>
<li>zhmc_nic_packets_received_count 已接收的单播数据包数</li>
<li>zhmc_nic_packets_sent_dropped_count 已丢弃的发送数据包数（资源短缺）</li>
<li>zhmc_nic_packets_received_dropped_count 已丢弃的接收数据包数（资源短缺）</li>
<li>zhmc_nic_packets_sent_discarded_count 已发送但被丢弃的数据包数量（格式错误）</li>
<li>zhmc_nic_packets_received_discarded_count 已接收但被丢弃的数据包数量（格式错误）</li>
<li>zhmc_nic_multicast_packets_sent_count 已发送的多播数据包数量</li>
<li>zhmc_nic_multicast_packets_received_count 已接收的多播数据包数量</li>
<li>zhmc_nic_broadcast_packets_sent_count 已发送的广播数据包数量</li>
<li>zhmc_nic_broadcast_packets_received_count 已接收的广播数据包数量</li>
<li>zhmc_nic_data_sent_bytes 通过集合发送的数据量间隔</li>
<li>zhmc_nic_data_received_bytes 收集间隔内接收的数据量</li>
<li>zhmc_nic_data_rate_sent_bytes_per_second 收集间隔内发送的数据速率</li>
<li>zhmc_nic_data_rate_received_bytes_per_second 收集间隔内接收的数据速率</li>
</ul>
</li>
</ul>
<h4 id="zhmcclient-的-NIC-类"><a href="#zhmcclient-的-NIC-类" class="headerlink" title="zhmcclient 的 NIC 类"></a>zhmcclient 的 NIC 类</h4><p><a target="_blank" rel="noopener" href="https://python-zhmcclient.readthedocs.io/en/stable/resources.html#nics">https://python-zhmcclient.readthedocs.io/en/stable/resources.html#nics</a></p>
<p>A NIC (Network Interface Card) is a logical entity that provides a Partition with access to external communication networks through a Network Adapter. More specifically, a NIC connects a Partition with a Network Port, or with a Virtual Switch which then connects to the Network Port.<br>NIC（网络接口卡）是一种逻辑实体，它通过网络适配器为分区提供访问外部通信网络的途径。更确切地说，NIC将分区连接到网络端口或虚拟交换机，然后虚拟交换机再连接到网络端口。</p>
<p>NIC resources are contained in Partition resources.<br>NIC 资源包含在分区资源中。</p>
<p>NICs only exist in CPCs that are in DPM mode.<br>NICs只存在于处于DPM模式的CPC中。</p>
<p>提供接口：</p>
<ul>
<li>list List the NICs in this Partition.<br>列出此分区中的 NIC。<br>可以在过滤器参数中指定任何资源属性。有关过滤器参数的详细信息，请参阅过滤。<br>资源列表以优化的方式处理：<br>如果此管理器启用了自动更新，则使用本地维护的资源列表（通过 HMC 的库存通知自动更新）并应用提供的过滤器参数。<br>否则，如果过滤器参数将资源名称指定为具有直接匹配字符串的单个过滤器参数（即没有正则表达式），则根据本地维护的名称 URI 缓存执行优化查找。<br>否则，将使用父对象中此资源的相应数组属性来列出资源，并应用提供的过滤器参数。</li>
<li>create<br>在此分区中创建并配置 NIC。<br>NIC 必须由适配器端口（在 OSA、ROCE 或 Hipersockets 适配器上）支持。</li>
</ul>
<p>此方法的“properties”参数中指定支持适配器端口的方式取决于适配器类型，如下所示：</p>
<p>对于 OSA 和 Hipersockets 适配器，“virtual-switch-uri”属性用于指定与支持适配器端口关联的虚拟交换机的 URI。</p>
<p>此虚拟交换机是一种资源，只要适配器资源存在，它就会自动存在。请注意，这些虚拟交换机不会显示在 HMC GUI 中；但它们会显示在 HMC REST API 中，因此也会显示在 zhmcclient API 中，作为 VirtualSwitch 类。</p>
<p>“virtual-switch-uri”属性的值可以根据给定的适配器名称和端口索引确定。</p>
<h4 id="zhmcclient-的-nic"><a href="#zhmcclient-的-nic" class="headerlink" title="zhmcclient 的 nic"></a>zhmcclient 的 nic</h4><ul>
<li>delete<br>Delete this NIC.</li>
<li>update_properties<br>Update writeable properties of this NIC.</li>
</ul>
<p>This method serializes with other methods that access or change properties on the same Python object.</p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><h5 id="针对roCE和cna"><a href="#针对roCE和cna" class="headerlink" title="针对roCE和cna"></a>针对roCE和cna</h5><ol>
<li>zhmcclient 来 list 出 CPCs 中每个 CPC 的partition list</li>
<li>获取每个 CPC 的网络适配器及其端口信息。</li>
<li>针对 partition list 中的每个 partition，获取其 NICs 和每个 NIC 对应的可用属性 network-adapter-port-uri，得到每一个 NIC 映射到的 adapter，也就是所有虚拟网卡和物理网卡的映射</li>
<li>通过获取每个分区的NIC使用统计信息来计算更具体的分区使用量</li>
</ol>
<h5 id="针对osd和iqd"><a href="#针对osd和iqd" class="headerlink" title="针对osd和iqd"></a>针对osd和iqd</h5><ol>
<li>zhmcclient 来 list 出 CPCs 中每个 CPC 的partition list</li>
<li>遍历所有CPC，获取每个CPC的虚拟交换机。对每个虚拟交换机，获取其关联的物理网卡和端口信息。</li>
<li>通过 virtual-switch-uri 找到对应的虚拟交换机。通过虚拟交换机找到对应的物理网卡</li>
<li>针对 partition list 中的每个 partition，获取其 NICs 和每个 NIC 对应的 virtual-switch-uri，找到对应的虚拟交换机。通过虚拟交换机找到对应的物理网卡，得到每一个 NIC 映射到的 adapter，也就是所有虚拟网卡和物理网卡的映射</li>
<li>通过获取每个分区的NIC使用统计信息来计算更具体的分区使用量</li>
</ol>
<p>NIC的属性：<a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/systems-hardware/zsystems/Z16M-A01?topic=model-data-nic-element-object#epm_partitionobj_datamodel_nic">Data model - NIC element object</a></p>
<p>（linuxone 和 zsystem的api有些是一样的）<br><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/module_1675371155154/pdf/SC27-2642-02.pdf">IBM SC27-2642-02, IBM Z Hardware Management Console Web Services API (Version 2.16.0)</a></p>
<p>The type of the NIC. The value of this property is derived implicitly from the backing adapter associated with this NIC on the Create NIC operation. Valid values are:<br>• “roce” - RDMA over Converged Ethernet.<br>• “iqd” - Internal Queued Direct.<br>• “osd” - OSA Direct Express<br>• “cna” - Cloud Network Adapter</p>
<p>这四种网络接口卡（NIC）类型分别代表了不同的网络技术和用途：</p>
<ol>
<li><p><strong>“roce” - RDMA over Converged Ethernet</strong>：</p>
<ul>
<li>RDMA over Converged Ethernet（RoCE）是一种网络技术，允许远程直接内存访问（RDMA）操作在以太网上执行。这意味着数据可以直接从一个服务器的内存传输到另一个服务器的内存，而无需CPU介入，从而减少延迟，提高数据传输效率。RoCE特别适用于高性能计算（HPC）和企业数据中心。</li>
</ul>
</li>
<li><p><strong>“iqd” - Internal Queued Direct</strong>：</p>
<ul>
<li>Internal Queued Direct（IQD）是一种专为高速数据处理设计的内部队列直接传输技术。它通常用于处理大量数据包或高速数据流，通过优化数据路径来减少延迟和提高吞吐量。IQD技术适用于需要高速数据处理能力的场景，如网络分析、高频交易等。</li>
</ul>
</li>
<li><p><strong>“osd” - OSA Direct Express</strong>：</p>
<ul>
<li>OSA Direct Express是指OSA（Open Systems Adapter）直接快速模式，是一种专为IBM Z系列计算机设计的网络适配器技术。它提供了高速、低延迟的网络通信能力，支持多种网络协议和服务。OSA Direct Express适用于需要高性能网络连接的大型企业环境。</li>
</ul>
</li>
<li><p><strong>“cna” - Cloud Network Adapter</strong>：</p>
<ul>
<li>Cloud Network Adapter（CNA）是一种专为云计算环境设计的网络接口卡。它支持虚拟化和多租户技术，能够提供灵活的网络配置和优化的数据流量管理。CNA旨在提高云数据中心的网络性能和效率，支持大规模虚拟化部署和云服务。</li>
</ul>
</li>
</ol>
<p>每种类型的NIC都针对特定的网络需求和应用场景进行了优化，从高性能计算到云计算环境，提供了不同的网络解决方案。</p>
<p>NIC element object的有关属性：<br>|Name|Qualifier|Type|Description|<br>|—-|—-|—-|—-|<br>network-adapter-port-uri|(w)(pc)|String/URI|The canonical URI path for the associated Network Port element object.Only present when type is <strong>“roce” or “cna”</strong>.|<br>|virtual-switch-uri |(w)(pc)|String/URI|The canonical URI path for the associated Virtual Switch object. <strong>Only present when type is “osd” or “iqd”.</strong> Constraint: If type is “iqd” and the Partition belongs to a CPC with API feature dpm-hipersockets-partition-link management available, this property is not writable. [Updated by feature dpm-hipersockets-partition-link-management]|</p>
<p>底层原理</p>
<ul>
<li>network-adapter-port-uri<ul>
<li>每个NIC在创建时都会与一个特定的物理适配器端口关联，这个关联信息通过network-adapter-port-uri属性保存。底层的原理是通过URI路径唯一标识了物理适配器的端口。通过查询这个URI路径，可以定位到具体的物理适配器及其端口。</li>
<li>例如：<ul>
<li>NIC A的network-adapter-port-uri是/api/adapters/adapter1/ports/port1。</li>
<li>这个URI路径直接指向物理适配器adapter1的port1，因此可以确定NIC A使用了物理适配器adapter1的port1。</li>
</ul>
</li>
</ul>
</li>
<li>virtual-switch-uri<ul>
<li>虚拟交换机（virtual switch）在底层实现了多个虚拟网卡（NIC）到物理网卡的连接。每个虚拟交换机都有一个唯一的URI路径，通过这个URI路径，可以找到连接到该交换机的所有NICs。</li>
<li>虚拟交换机的作用是将多个分区的虚拟网络流量汇聚到一起，并将其分配给一个或多个物理网络适配器。因此，通过查询虚拟交换机的URI路径，可以间接找到与该交换机关联的所有物理适配器。</li>
<li>例如：<ul>
<li>虚拟交换机S的virtual-switch-uri是/api/virtual-switches/switch1。</li>
<li>连接到交换机S的所有NICs（如NIC B和NIC C）共享同一个virtual-switch-uri。</li>
<li>查询虚拟交换机switch1的配置，可以找到其底层连接的物理适配器，从而确定NIC B和NIC C使用的物理适配器。</li>
</ul>
</li>
</ul>
</li>
<li>利用network-adapter-port-uri和virtual-switch-uri属性，可以从虚拟的NIC对象追溯到实际的物理网络适配器。这两个属性在确定NIC与物理网卡的关联性方面非常有用，能够帮助我们实现物理网卡的总用量监控，并进一步细化到每个分区的用量监控。<h4 id="virtual-switch"><a href="#virtual-switch" class="headerlink" title="virtual switch"></a>virtual switch</h4></li>
<li>虚拟交换机是将 NIC 与网络端口连接起来的虚拟化网络交换机。每次检测到并配置新的网络适配器时，都会自动生成虚拟交换机。</li>
<li>虚拟交换机资源包含在 CPC 资源中。</li>
<li>虚拟交换机仅存在于处于 DPM 模式的 CPC 中。</li>
</ul>
<h2 id="第五周"><a href="#第五周" class="headerlink" title="第五周"></a>第五周</h2><h3 id="思路形成的py脚本（并不适用，只用来理解思路）"><a href="#思路形成的py脚本（并不适用，只用来理解思路）" class="headerlink" title="思路形成的py脚本（并不适用，只用来理解思路）"></a>思路形成的py脚本（并不适用，只用来理解思路）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zhmcclient <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 HMC 连接</span></span><br><span class="line">session = Session(<span class="string">&#x27;hmc_host&#x27;</span>, <span class="string">&#x27;hmc_user&#x27;</span>, <span class="string">&#x27;hmc_password&#x27;</span>)</span><br><span class="line">client = session.client</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有 CPC</span></span><br><span class="line">cpcs = client.cpcs.<span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化数据结构</span></span><br><span class="line">adapter_usage = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有虚拟交换机及其关联的物理网卡</span></span><br><span class="line">virtual_switches = []</span><br><span class="line"><span class="keyword">for</span> cpc <span class="keyword">in</span> cpcs:</span><br><span class="line">    v_switches = cpc.virtual_switches.<span class="built_in">list</span>()</span><br><span class="line">    virtual_switches.extend(v_switches)</span><br><span class="line">    <span class="keyword">for</span> v_switch <span class="keyword">in</span> v_switches:</span><br><span class="line">        adapters = v_switch.adapters.<span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> adapter <span class="keyword">in</span> adapters:</span><br><span class="line">            ports = adapter.ports.<span class="built_in">list</span>()</span><br><span class="line">            <span class="keyword">for</span> port <span class="keyword">in</span> ports:</span><br><span class="line">                adapter_usage[port.uri] = &#123;<span class="string">&#x27;total_sent_bytes&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;total_received_bytes&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;partitions&#x27;</span>: &#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有分区及其NIC信息，并收集使用统计信息</span></span><br><span class="line"><span class="keyword">for</span> cpc <span class="keyword">in</span> cpcs:</span><br><span class="line">    partitions = cpc.partitions.<span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> partition <span class="keyword">in</span> partitions:</span><br><span class="line">        nics = partition.nics.<span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> nic <span class="keyword">in</span> nics:</span><br><span class="line">            v_switch_uri = nic.get(<span class="string">&#x27;virtual-switch-uri&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> v_switch_uri:</span><br><span class="line">                <span class="comment"># 通过虚拟交换机找到对应的物理网卡</span></span><br><span class="line">                v_switch = <span class="built_in">next</span>((vs <span class="keyword">for</span> vs <span class="keyword">in</span> virtual_switches <span class="keyword">if</span> vs.uri == v_switch_uri), <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> v_switch:</span><br><span class="line">                    adapters = v_switch.adapters.<span class="built_in">list</span>()</span><br><span class="line">                    <span class="keyword">for</span> adapter <span class="keyword">in</span> adapters:</span><br><span class="line">                        ports = adapter.ports.<span class="built_in">list</span>()</span><br><span class="line">                        <span class="keyword">for</span> port <span class="keyword">in</span> ports:</span><br><span class="line">                            <span class="keyword">if</span> port.uri <span class="keyword">in</span> adapter_usage:</span><br><span class="line">                                <span class="comment"># 获取NIC的使用统计信息</span></span><br><span class="line">                                sent_bytes = get_prometheus_metric(<span class="string">f&#x27;zhmc_nic_bytes_sent_count&#123;&#123;nic=&quot;<span class="subst">&#123;nic.name&#125;</span>&quot;&#125;&#125;&#x27;</span>)</span><br><span class="line">                                received_bytes = get_prometheus_metric(<span class="string">f&#x27;zhmc_nic_bytes_received_count&#123;&#123;nic=&quot;<span class="subst">&#123;nic.name&#125;</span>&quot;&#125;&#125;&#x27;</span>)</span><br><span class="line">                                </span><br><span class="line">                                <span class="comment"># 更新物理网卡的总用量</span></span><br><span class="line">                                adapter_usage[port.uri][<span class="string">&#x27;total_sent_bytes&#x27;</span>] += sent_bytes</span><br><span class="line">                                adapter_usage[port.uri][<span class="string">&#x27;total_received_bytes&#x27;</span>] += received_bytes</span><br><span class="line">                                </span><br><span class="line">                                <span class="comment"># 更新分区的使用信息</span></span><br><span class="line">                                <span class="keyword">if</span> partition.name <span class="keyword">not</span> <span class="keyword">in</span> adapter_usage[port.uri][<span class="string">&#x27;partitions&#x27;</span>]:</span><br><span class="line">                                    adapter_usage[port.uri][<span class="string">&#x27;partitions&#x27;</span>][partition.name] = &#123;<span class="string">&#x27;sent_bytes&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;received_bytes&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line">                                adapter_usage[port.uri][<span class="string">&#x27;partitions&#x27;</span>][partition.name][<span class="string">&#x27;sent_bytes&#x27;</span>] += sent_bytes</span><br><span class="line">                                adapter_usage[port.uri][<span class="string">&#x27;partitions&#x27;</span>][partition.name][<span class="string">&#x27;received_bytes&#x27;</span>] += received_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line"><span class="keyword">for</span> port_uri, usage <span class="keyword">in</span> adapter_usage.items():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Adapter Port URI: <span class="subst">&#123;port_uri&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Total Sent Bytes: <span class="subst">&#123;usage[<span class="string">&#x27;total_sent_bytes&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Total Received Bytes: <span class="subst">&#123;usage[<span class="string">&#x27;total_received_bytes&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> partition_name, partition_usage <span class="keyword">in</span> usage[<span class="string">&#x27;partitions&#x27;</span>].items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Partition: <span class="subst">&#123;partition_name&#125;</span>, Sent Bytes: <span class="subst">&#123;partition_usage[<span class="string">&#x27;sent_bytes&#x27;</span>]&#125;</span>, Received Bytes: <span class="subst">&#123;partition_usage[<span class="string">&#x27;received_bytes&#x27;</span>]&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>文档：The exporter code is agnostic to the actual set of metrics supported by the HMC. A new metric exposed by the HMC metric service or a new property added to one of the auto-updated resources can immediately be supported by just adding it to the Metric definition file.</p>
</blockquote>
<p>本来想看看测试机上exporter的文件怎么配置的, 用find命令找到了三个metrics.yaml:<br><img src="../image/image-363.png" alt="alt text"><br>不小心 attach 到 <code>zhmc_promethues_exporter</code> 容器,然后误操作用 <code>ctrl z</code> 和 <code>ctrl c</code> 命令把容器的进程给中断了, 没想到容器直接被删除了(docker ps -a也没有)..<br>控制台操作日志如下:<br><img src="../image/image-364.png" alt="alt text"><br><img src="../image/image-365.png" alt="alt text"><br><img src="../image/image-366.png" alt="alt text"><br>马上参照官方文档: 用docker(实际上是podman)运行zhmc_prometheus_exporter,再找到本机上的hmccreds.yaml文件,把hmccreds.yaml文件挂载到容器中,并且把容器的端口映射到本机的端口,启动容器.<br><img src="../image/image-367.png" alt="alt text"><br>重新启动成功后, 端口映射成功, 可以通过浏览器访问到zhmc_prometheus_exporter的web页面, 并且可以看到metrics数据. 同时Prometheus和Grafana也可以通过配置文件访问到zhmc_prometheus_exporter的metrics数据. 大概上是复原了.</p>
<p>后来和fulong老师交流了一下，给我多开了一个跑exporter容器来用于有需要修改metrics.yaml的时候进行测试。</p>
<h3 id="疑惑1"><a href="#疑惑1" class="headerlink" title="疑惑1"></a>疑惑1</h3><p>讨论的核心是如何有效地向 Prometheus 和 Grafana 提供所需的指标数据，以支持分析和监控。老师提出，通过修改 exporter 配置来直接获取所需的参数，并让这些参数被 Prometheus 抓取，是一种更自动化和高效的方法。这样做可以避免重复造轮子，即避免自己编写脚本去收集数据，因为这相当于重新实现 exporter 的功能。确认了后端代码将只与 Prometheus 交互，而不是直接与 zhmcclient 或 exporter 打交道，即使某些参数可以通过后端代码简单获取，最终仍然需要考虑如何将这些数据发送给 Prometheus。如果不这样做，应用程序将需要处理来自两个数据源的数据，这会增加数据整合和一致性的复杂性。</p>
<p>结论是，为了简化数据流和避免不必要的复杂性，决定保持单一的数据源，即通过配置 exporter 来自动化地向 Prometheus 提供所需的指标数据，而不是在后端代码中自己处理数据收集和发送的任务。这种方法有助于保持系统的整洁和可维护性。</p>
<h3 id="可能需要调动的API："><a href="#可能需要调动的API：" class="headerlink" title="可能需要调动的API："></a>可能需要调动的API：</h3><h4 id="CPC"><a href="#CPC" class="headerlink" title="CPC"></a>CPC</h4><ul>
<li>CPCManager(client)<ul>
<li>List(): List the CPCs managed by the HMC this client is connected to.</li>
</ul>
</li>
<li>CPC<ul>
<li>partitions: Access to the Partitions in this CPC.</li>
<li>adapters: Access to the Adapters in this CPC.</li>
<li>virtual_switches: Access to the Virtual Switches in this CPC.<h4 id="Virtual-Switch"><a href="#Virtual-Switch" class="headerlink" title="Virtual Switch"></a>Virtual Switch</h4></li>
</ul>
</li>
<li>VirtualSwitchManager(cpc)<ul>
<li>List(): List the Virtual Switches in this CPC.</li>
</ul>
</li>
<li>VirtualSwitch<ul>
<li>List the NICs connected to this Virtual Switch.<h4 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h4></li>
</ul>
</li>
<li>AdapterManager(cpc)<ul>
<li>List(): List the Adapters in this CPC.</li>
</ul>
</li>
<li>Adapter<ul>
<li>ports: Access to the Ports in this Adapter.<h4 id="Port"><a href="#Port" class="headerlink" title="Port"></a>Port</h4></li>
</ul>
</li>
<li>PortManager(adapter, port_type)<ul>
<li>List(): List the Ports in this Adapter.</li>
</ul>
</li>
<li>port<ul>
<li>manager<h4 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h4></li>
</ul>
</li>
<li>PartitionManager(cpc)<ul>
<li>List(): List the Partitions in this CPC.</li>
</ul>
</li>
<li>Partition<ul>
<li>nics: Access to the NICs in this Partition.<h4 id="NIC"><a href="#NIC" class="headerlink" title="NIC"></a>NIC</h4></li>
</ul>
</li>
<li>NicManager(partition)<ul>
<li>List(): List the NICs in this Partition.</li>
</ul>
</li>
<li>NIC<ul>
<li>backing_port(): Return the backing adapter port of the NIC.</li>
<li>get_property(name): Get the value of a property of this NIC.</li>
<li>property:<ul>
<li>network_adapter_port_uri: The URI of the Network Adapter Port associated with this NIC.</li>
<li>virtual_switch_uri: The URI of the Virtual Switch associated with this NIC.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>NIC 必须由适配器端口（在 OSA、ROCE 或 Hipersockets 适配器上）支持。</p>
<p>此方法的“properties”参数中指定支持适配器端口的方式取决于适配器类型，如下所示：</p>
<p>对于 OSA 和 Hipersockets 适配器，“virtual-switch-uri”属性用于指定与支持适配器端口关联的虚拟交换机的 URI。</p>
<p>此虚拟交换机是一种资源，只要适配器资源存在，它就会自动存在。请注意，这些虚拟交换机不会显示在 HMC GUI 中；但它们会显示在 HMC REST API 中，因此也会显示在 zhmcclient API 中，作为 VirtualSwitch 类。</p>
<p>“virtual-switch-uri”属性的值可以根据给定的适配器名称和端口索引确定。</p>
<h3 id="疑惑2"><a href="#疑惑2" class="headerlink" title="疑惑2"></a>疑惑2</h3><ul>
<li>类似于list的API有没有作为指标提供？似乎没有。</li>
<li>如何提供作为指标？似乎不是量化的，跟原有的指标不一样，因为不是简单的数字</li>
<li>是属于资源指标吗？跟量化指标不一样吗？<br><img src="../image/image-368.png" alt="alt text"><br><img src="../image/image-369.png" alt="alt text"><br>和李老师交流了一下，重新确认了需求和思路：</li>
<li>一方面，获取拓扑结构相关的东西这个公司以前都是有的，但是直接拿出来不合规；</li>
<li>另一方面，拓扑结构和数据可能存在不一致的可能：<ul>
<li>listen同步机制，理论上是一致的，但是可能存在更新的时间节点不一样的情况。数据不一致的时候两个数据源可能还需要取舍等等。而且如果发生错误，定位错误的时候会比较麻烦。</li>
</ul>
</li>
<li>所以调整思路：就只从exporter的角度出发，不要从拓扑结构出发，也不需要zhmcclient的API了，原有的指标输出就已足够。</li>
<li>接下来的问题是怎么展示（<a target="_blank" rel="noopener" href="https://github.com/JasonCrash/LOP-API/issues/16">issue16</a>）：<ul>
<li>adapter的用量总数和每个partition的用量</li>
<li>比如机器上有一百张卡，要怎么展示视图？<ul>
<li>所有的网卡的实时流量数据，点一下detail，展示所有的用到的partition的流量数据</li>
</ul>
</li>
</ul>
</li>
<li>明确业务开发逻辑：grafana的作用是可以通过promQL给前端提供视图；而后端可以通过promQL给前端提供API来获取数据。</li>
</ul>
<h3 id="最终解决方案"><a href="#最终解决方案" class="headerlink" title="最终解决方案"></a>最终解决方案</h3><p>最终，使用一部分可用的指标，通过grafana中的promQL来展示视图，而不是直接从zhmcclient中获取数据。<br>在Grafana上新建一个Adapter view，里面有一个表格panel，点击可以实时调整packets和bytes这两个panel，展示对应adapter的具体用量分配情况。</p>
<p>具体如何使用grafana进行满足需求的配置和操作。</p>
<ul>
<li>dashboard variable：设置dashboard 范围内的变量 <code>$adapter_name</code>，可以在整个 dashboard 中使用，可以用query从数据源中的指标标签中获取变量允许的值。</li>
<li>data link：支持数据点作为链接，点击可以跳转到设置的url<ul>
<li>url设置格式：( <code>Field</code> 是adapter名称那一列的表头名称，用 <code>$&#123;__data.fields.Field&#125;</code> 获取)：<ul>
<li><code>http://172.16.36.127:3000/d/aa37fb63-90cd-46ef-abf1-861f71b31745/adapter-view?var-adapter_name=$&#123;__data.fields.Field&#125;</code></li>
</ul>
</li>
</ul>
</li>
<li>目标panel的query语句中使用变量：<ul>
<li><code>sum(zhmc_nic_packets_sent_count_total&#123;adapter=&quot;$adapter_name&quot;&#125;) by (partition)</code><h2 id="第六周"><a href="#第六周" class="headerlink" title="第六周"></a>第六周</h2><img src="../image/image-381.png" alt="alt text"><br><img src="../image/image-380.png" alt="alt text"><br><img src="../image/image-377.png" alt="alt text"><br><img src="../image/image-378.png" alt="alt text"><br><img src="../image/image-379.png" alt="alt text"><h3 id="相似产品调研"><a href="#相似产品调研" class="headerlink" title="相似产品调研"></a>相似产品调研</h3></li>
</ul>
</li>
<li>Zabbix </li>
<li>Nagios 预览版需要下载部署</li>
<li>SolarWinds<ul>
<li><a target="_blank" rel="noopener" href="https://www.solarwinds.com/interactive-demos">interactive-demos 主页</a></li>
<li><a target="_blank" rel="noopener" href="https://hco.demo.solarwinds.com/Orion/SummaryView.aspx?viewkey=Summary+Home+Narrow">Hybrid Cloud Observability</a></li>
<li><a target="_blank" rel="noopener" href="https://demo.na-01.cloud.solarwinds.com/?program=999&amp;campaign=7012J000001J8VVQA0&amp;parentCampaign=7012J000001J8VVQA0&amp;duration=3600">SolarWinds Observability</a><br>  <img src="../image/image-375.png" alt="alt text"><br>  <img src="../image/image-376.png" alt="alt text"></li>
</ul>
</li>
<li>PRTG? </li>
<li>Netdata<ul>
<li><a target="_blank" rel="noopener" href="https://app.netdata.cloud/spaces/netdata-demo/rooms/all-nodes/overview?_gl=1*hdpqyi*_gcl_au*NzM1NDE2NjQ0LjE3MjEwMjc4NjE.*_ga*Mzc5NjA0NTQ1LjE3MjEwMjc4NjE.*_ga_J69Z2JCTFB*MTcyMTAyNzg2MS4xLjEuMTcyMTAyNzg2MS42MC4wLjA.#metrics_correlation=false&amp;after=-900&amp;before=0&amp;utc=Asia%2FShanghai&amp;offset=%2B8&amp;timezoneName=Beijing%2C%20Chongqing%2C%20Hong%20Kong%2C%20Urumqi&amp;modal=&amp;modalTab=&amp;modalParams=&amp;selectedIntegrationCategory=deploy.operating-systems&amp;force_play=false&amp;d8a4e0c5-7c79-4145-900e-83a9f06fcb6a--chartName-val=menu_system">Netdata console</a><br><img src="../image/image-374.png" alt="alt text"><br><img src="../image/image-372.png" alt="alt text"><br><img src="../image/image-373.png" alt="alt text"></li>
</ul>
</li>
</ul>
<h3 id="展示"><a href="#展示" class="headerlink" title="展示"></a>展示</h3><p>比如你是一个用户，你现在打开页面看到什么，查看每一个网卡具体内容的时候具体有哪些内容，页面大体长什么样子，你可以简单用ppt画两个框，说明一下问题。</p>
<h3 id="重新迭代"><a href="#重新迭代" class="headerlink" title="重新迭代"></a>重新迭代</h3><ul>
<li>重新设计 CPC/Adapter view，Adapter/Partition view</li>
<li>调整 stat panel 进行排序<br><img src="../image/image-382.png" alt="alt text"><br><img src="../image/image-383.png" alt="alt text"></li>
<li>优化饼状图<ul>
<li>记得选中 Legend</li>
</ul>
</li>
<li>三个 panel<br><img src="../image/image-385.png" alt="alt text"><ul>
<li>时间序列</li>
<li>指标数据 top5 的 Adapter 时间序列展示<ul>
<li>合理利用 grafana 的内置变量和 promQL 的函数，如 <code>topk</code>、<code>__range</code>、<code>__interval</code> 等<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(5, sum(rate(zhmc_adapter_usage_ratio&#123;cpc=&quot;$cpc_name&quot;&#125;[$__range])) by (adapter))</span><br></pre></td></tr></table></figure></li>
<li><a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/dashboards/variables/add-template-variables/#global-variables">内置变量官方文档</a><br><img src="../image/image-388.png" alt="alt text"></li>
</ul>
</li>
<li>大表格细节展示<ul>
<li><strong>Data Transform 可以针对每一个查询的结果进行处理！</strong><ul>
<li>reduce：用来简化时间序列<br><img src="../image/image-387.png" alt="alt text"></li>
<li>join by fileds：可以将两个查询的结果按照某个字段进行合并</li>
<li>Filter data by values：可以根据某个字段的值进行过滤</li>
<li>organize fields：可以对table中的列进行排序、重命名</li>
</ul>
</li>
<li>override fields：可以对table中具体某一列进行特殊处理，例如设置别名、单位、空值处理等<h4 id="迭代历程："><a href="#迭代历程：" class="headerlink" title="迭代历程："></a>迭代历程：</h4><img src="../image/image-386.png" alt="alt text"><h2 id="第七周"><a href="#第七周" class="headerlink" title="第七周"></a>第七周</h2><h3 id="nvestigate-how-to-call-own-API-through-grafana-alert-35"><a href="#nvestigate-how-to-call-own-API-through-grafana-alert-35" class="headerlink" title="nvestigate how to call own API through grafana alert #35"></a>nvestigate how to call own API through grafana alert #35</h3>grafana 一旦触发了 alert 之后，如何调用让 grafana 调用我们自己的接口？</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>设置告警条件来触发alter：<br><img src="../image/image-389.png" alt="alt text"><br>Contact points：<br><img src="../image/image-391.png" alt="alt text"><br>测试：<br><img src="../image/image-392.png" alt="alt text"></p>
<h3 id="Design-API-for-alert-36"><a href="#Design-API-for-alert-36" class="headerlink" title="Design API for alert #36"></a>Design API for alert #36</h3><p>设计一个我们自己的接口，这个接口的作用是收到grafana 的信息之后，把这个信息转换成我们自己的message，保存数据库</p>
<p><img src="../image/image-394.png" alt="alt text"></p>
<p>这里面涉及到的是后端我们自己的 message 的数据格式。</p>
<p>接口设计出来之后，要写 API doc，找钥开问一下</p>
<p>接口具体实现后面再说</p>
<h3 id="配合前端集成页面"><a href="#配合前端集成页面" class="headerlink" title="配合前端集成页面"></a>配合前端集成页面</h3><h2 id="第八周"><a href="#第八周" class="headerlink" title="第八周"></a>第八周</h2><h3 id="重建-Grafana-的-dashboard"><a href="#重建-Grafana-的-dashboard" class="headerlink" title="重建 Grafana 的 dashboard"></a>重建 Grafana 的 dashboard</h3><p>很不幸，被覆盖了</p>
<h3 id="Alert-Manager"><a href="#Alert-Manager" class="headerlink" title="Alert-Manager"></a>Alert-Manager</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/alertmanager/">Alertmanager</a></p>
<h2 id="第九周"><a href="#第九周" class="headerlink" title="第九周"></a>第九周</h2><p>在 value 里面 传 cpc name，partition name， cpu rate，还有一个时间戳，这样就能够明确说明 哪个cpc里面的哪个partition在什么时间cpu利用率过高 高达X%</p>
</li>
<li><p>add alter_controller</p>
</li>
<li>modify message_service<br><img src="../image/image-417.png" alt="alt text"><h3 id="备份grafana"><a href="#备份grafana" class="headerlink" title="备份grafana"></a>备份grafana</h3><h2 id="第十周"><a href="#第十周" class="headerlink" title="第十周"></a>第十周</h2>grafana 的 webhook 还是 altermanager 的 webhook？</li>
</ul>
<p>grafana</p>
<h3 id="业务逻辑梳理："><a href="#业务逻辑梳理：" class="headerlink" title="业务逻辑梳理："></a>业务逻辑梳理：</h3><p>后续前后端可能要有一个 alter 接口，用于前端页面显示，点一下跳转前端的 message 页面<br>前端一般提供给用户来查看 metrics 的时候<br>后端异步告警，前端查询后端，从后端获取告警信息，提示用户</p>
<h3 id="测试过程中的问题及其解决"><a href="#测试过程中的问题及其解决" class="headerlink" title="测试过程中的问题及其解决"></a>测试过程中的问题及其解决</h3><h4 id="关于远程的测试机无法访问我本地的服务："><a href="#关于远程的测试机无法访问我本地的服务：" class="headerlink" title="关于远程的测试机无法访问我本地的服务："></a>关于远程的测试机无法访问我本地的服务：</h4><ul>
<li>使用 ngrok 暴露本地服务端口到公网供测试访问</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngrok http https://localhost:18443</span><br></pre></td></tr></table></figure>
<p>注意：免费版ip不稳定，每次运行都会变。</p>
<h4 id="关于证书的问题："><a href="#关于证书的问题：" class="headerlink" title="关于证书的问题："></a>关于证书的问题：</h4><ol>
<li>证书过期了<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">grafana 报错</span></span><br><span class="line">Failed to send test alert.: Post</span><br><span class="line">&quot;https://xxx:18443/api/v1/message&quot;: tls: failed to verifycertificate: x509: certificate has expired or is not yet valid: current time2024-08-09T03:47:01Zis after 2022-06-22T02:58:48Z</span><br></pre></td></tr></table></figure>
日志：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器日志</span></span><br><span class="line">ssl.SSLError: [SSL: SSLV3_ALERT_BAD_CERTIFICATE] sslv3 alert bad certificate (_ssl.c:1131)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器日志</span></span><br><span class="line">server.go:3214: http: TLS handshake error from 10.0.2.23:57123: remote error: tls: unknown certificate</span><br></pre></td></tr></table></figure>
x.509 证书过期或者未启用，而 grafana 不支持绕过 tls 验证。<br>重新生成证书，替换之后，遇到新的问题。</li>
<li>证书中不包含IP地址<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">grafana 报错</span></span><br><span class="line">Failed to send test alert.: Post</span><br><span class="line">&quot;https://xxx:18443/api/v1/auth/token&quot;: tls: failed to verifycertificate: x509: cannot validate certificate for xxx because itdoesn&#x27;t contain any IP SANs</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>在 openssl.cnf 中配置 IP 的信息<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ alt_names ]   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">one Common Name</span>   </span><br><span class="line">DNS.1 = test.ibm.com </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">other extra DNS name</span>   </span><br><span class="line">IP.1 = xx.xx.xx.xx</span><br></pre></td></tr></table></figure>
然后基于更新后的 openssl.cnf 重新生成自签名证书。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -nodes -keyout server.key -out server.csr -config openssl.cnf</span><br><span class="line">openssl x509 -req -days 3650 -<span class="keyword">in</span> server.csr -signkey server.key -out server.crt -extensions v3_req -extfile openssl.cnf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li>然后报错信息变化了：提示证书是自签名的，不是由可信的CA签发的：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">grafana 报错</span></span><br><span class="line">Failed to send test alert.: Post&quot;https://xxx:18443/api/v1/auth/token&quot;: tls: failed to verifycertificate: x509: certificate signed by unknown authority (possiblybecause of &quot;crypto/rsa: verification error&quot; while trying to verifycandidate authority certificate &quot;Default Company Ltd&quot;&quot;)</span><br></pre></td></tr></table></figure>
接下来要做的就是让 grafana 认可我们自己的 CA 证书，这样就可以通过自签名证书来解决问题了。具体来说，需要将自签名证书的 CA 证书添加到 grafana 容器的信任证书列表中。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker cp ca.crt grafana:/etc/ssl/certs/ca.crt</span><br><span class="line">docker exec -it grafana /bin/bash</span><br><span class="line">update-ca-certificates</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>问题解决。</p>
<h3 id="研究-grafana-webhook-提供具体信息的具体设置"><a href="#研究-grafana-webhook-提供具体信息的具体设置" class="headerlink" title="研究 grafana webhook 提供具体信息的具体设置"></a>研究 grafana webhook 提供具体信息的具体设置</h3><p><a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/alerting/alerting-rules/templating-labels-annotations/">https://grafana.com/docs/grafana/latest/alerting/alerting-rules/templating-labels-annotations/</a></p>
<h4 id="alert-rules"><a href="#alert-rules" class="headerlink" title="alert rules"></a>alert rules</h4><ul>
<li>根据查询返回的指标字段，自动提取识别labels，供自定义配置使用</li>
<li>告警规则如何针对多个对象？<ul>
<li>因为告警规则是在没有仪表板上下文的环境中执行的。因此，你需要修改查询以支持多维度告警，这样 Grafana 可以在告警规则中根据每个分区的 CPU 使用率自动生成告警实例。</li>
</ul>
</li>
<li>TODO!在同一个告警规则中，如果设置了label不同的多条查询语句，会有明明查询到了非零值，annotation 里却显示为0的问<h4 id="contact-points"><a href="#contact-points" class="headerlink" title="contact points"></a>contact points</h4></li>
<li>与 alert rules 的关系是多对一</li>
<li>只支持的账号密码验证和 token 验证，而且两者不能同时使用</li>
<li>不支持绕过 tls 检验<h4 id="notification-policies"><a href="#notification-policies" class="headerlink" title="notification policies"></a>notification policies</h4><h4 id="code"><a href="#code" class="headerlink" title="code"></a>code</h4></li>
<li>constant.py 新增字典映射，匹配 alertname 到 template_name</li>
<li>status 的含义是该消息已读/未读</li>
<li>value 的拼装，labels + value + timestamp + 分析调优建议</li>
</ul>
<h2 id="第十一、十二周（休假）"><a href="#第十一、十二周（休假）" class="headerlink" title="第十一、十二周（休假）"></a>第十一、十二周（休假）</h2><h3 id="一键备份-grafana-配置"><a href="#一键备份-grafana-配置" class="headerlink" title="一键备份 grafana 配置"></a>一键备份 grafana 配置</h3><p><a target="_blank" rel="noopener" href="https://github.com/ysde/grafana-backup-tool">grafana-backup-tool</a><br><img src="../image/image-418.png" alt="alt text"><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --user $(id -u):$(id -g) --rm --name grafana-backup-tool \</span><br><span class="line">           -e GRAFANA_TOKEN= YOUR_TOKEN \</span><br><span class="line">           -e GRAFANA_URL= YOUR_API \</span><br><span class="line">           -e GRAFANA_ADMIN_ACCOUNT= USER \</span><br><span class="line">           -e GRAFANA_ADMIN_PASSWORD= PASSWORD \</span><br><span class="line">           -e VERIFY_SSL= False \</span><br><span class="line">           -v /tmp/backup/ : /opt/grafana-backup-tool/_OUTPUT_  \</span><br><span class="line">           ysde/docker-grafana-backup-tool</span><br></pre></td></tr></table></figure></p>
<h2 id="第不知道第几周，项目重启！目标：十月中旬完成MVP和汇报视频"><a href="#第不知道第几周，项目重启！目标：十月中旬完成MVP和汇报视频" class="headerlink" title="第不知道第几周，项目重启！目标：十月中旬完成MVP和汇报视频"></a>第不知道第几周，项目重启！目标：十月中旬完成MVP和汇报视频</h2><h3 id="后端开发需求设想"><a href="#后端开发需求设想" class="headerlink" title="后端开发需求设想"></a>后端开发需求设想</h3><h4 id="AI模块"><a href="#AI模块" class="headerlink" title="AI模块"></a>AI模块</h4><ul>
<li>【需求对接】跟前端同学商量好以什么形式展示机器学习算法提供的预测结果，这一块可以调研一下其他产品</li>
<li>【接口实现】后端利用AI组提供的接口调用，基于上述调研结果形成的需求实现一套提供给前端用户用于跟AI模块交互的接口</li>
<li>【AI-后端-前端联调】</li>
</ul>
<h4 id="message模块接口结构优化"><a href="#message模块接口结构优化" class="headerlink" title="message模块接口结构优化"></a>message模块接口结构优化</h4><p>如果有时间，后端可以考虑重构一下 message_service 的 process_alter 这个api，提供一个更加通用的接口，不仅能支持CPUAlter，也能支持NetworkAlter等等。</p>
<h4 id="grafana-配置network的告警规则"><a href="#grafana-配置network的告警规则" class="headerlink" title="grafana 配置network的告警规则"></a>grafana 配置network的告警规则</h4><p>如果时间允许的话能完成这一块，就可以在汇报视频中展示更多的告警规则和情节。</p>
<h4 id="结项视频制作"><a href="#结项视频制作" class="headerlink" title="结项视频制作"></a>结项视频制作</h4><ul>
<li>视频脚本的编写：设置一个情景，讲好一个故事，让观众能够更好地理解项目的背景、需求、解决方案和成果</li>
<li>动画制作：通过动画的形式展示项目的流程和结果，让观众更加直观地了解项目的实现过程和效果</li>
<li>配音录制：录制配音，为视频增添声音</li>
<li>视频剪辑：将录制好的视频和配音进行剪辑，制作成最终的成品</li>
</ul>
<h3 id="数据库连接"><a href="#数据库连接" class="headerlink" title="数据库连接"></a>数据库连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it ecs_db /bin/bash</span><br><span class="line">mysql -h localhost -P 3306 -u root -p</span><br><span class="line">SHOW DATABASES;</span><br><span class="line">USE ecs_api;</span><br><span class="line">SHOW TABLES;</span><br></pre></td></tr></table></figure>
<h2 id="重新搭建环境部署上线"><a href="#重新搭建环境部署上线" class="headerlink" title="重新搭建环境部署上线"></a>重新搭建环境部署上线</h2><h3 id="镜像制作"><a href="#镜像制作" class="headerlink" title="镜像制作"></a>镜像制作</h3><h4 id="LOP-API"><a href="#LOP-API" class="headerlink" title="LOP-API"></a>LOP-API</h4><p>[√] 自己打包上传服务器</p>
<h4 id="prometheus、mariaDB"><a href="#prometheus、mariaDB" class="headerlink" title="prometheus、mariaDB"></a>prometheus、mariaDB</h4><p>[√] 略</p>
<h4 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h4><p>[√] 开源的s390x架构grafana镜像构建 <a target="_blank" rel="noopener" href="https://github.com/linux-on-ibm-z/dockerfile-examples/tree/master/Grafana">https://github.com/linux-on-ibm-z/dockerfile-examples/tree/master/Grafana</a></p>
<h5 id="如何添加基于文件的-Swap-空间："><a href="#如何添加基于文件的-Swap-空间：" class="headerlink" title="如何添加基于文件的 Swap 空间："></a>如何添加基于文件的 Swap 空间：</h5><p>在 Linux 系统中，添加基于文件的 Swap 空间是一种增加虚拟内存的方法。Swap 空间可以看作是硬盘上的一部分空间，被用作 RAM 使用。当系统的物理内存（RAM）不足时，操作系统会将一些不常用的数据从 RAM 移动到 Swap 空间中，以便为新的数据腾出空间。这有助于防止系统因内存不足而崩溃。</p>
<ol>
<li><p><strong>创建 Swap 文件</strong>：<br>首先，你需要创建一个 Swap 文件。这可以通过 <code>fallocate</code> 或 <code>dd</code> 命令完成。例如，创建一个 1GB 的 Swap 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fallocate -l 1G /swapfile</span><br></pre></td></tr></table></figure>
<p>或者使用 <code>dd</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1024 count=1048576</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>设置文件权限</strong>：<br>为了安全起见，确保只有 root 用户可以访问 Swap 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 600 /swapfile</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>格式化为 Swap 格式</strong>：<br>将文件格式化为 Swap 格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkswap /swapfile</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>启用 Swap 文件</strong>：<br>激活 Swap 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapon /swapfile</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>验证 Swap 空间</strong>：<br>使用以下命令验证 Swap 空间是否已启用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -h</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon --show</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>永久启用 Swap 文件</strong>：<br>如果你想在系统重启后仍然使用这个 Swap 文件，需要将其添加到 <code>/etc/fstab</code> 文件中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/swapfile none swap sw 0 0&#x27;</span> | sudo <span class="built_in">tee</span> -a /etc/fstab</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>调整 Swap 行为</strong>：<br>你可以通过 <code>/proc/sys/vm/swappiness</code> 文件来调整系统使用 Swap 的倾向性。值越高，系统越倾向于使用 Swap 空间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl vm.swappiness=10</span><br></pre></td></tr></table></figure>
<p>这会将 <code>swappiness</code> 值设置为 10，可以根据需要调整这个值。</p>
</li>
</ol>
<h5 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h5><ul>
<li><strong>性能影响</strong>：虽然 Swap 空间可以在内存不足时提供帮助，但它的速度比物理内存慢得多，频繁使用 Swap 可能会导致系统性能下降。</li>
<li><strong>磁盘空间</strong>：确保你有足够的磁盘空间来创建 Swap 文件。</li>
<li><strong>磁盘类型</strong>：如果可能，将 Swap 文件放在 SSD 上，而不是 HDD，因为 SSD 的读写速度更快。</li>
</ul>
<p>添加 Swap 空间是一种有效的短期解决方案，但最好还是增加物理内存以获得更好的性能。</p>
<h3 id="grafana-备份恢复"><a href="#grafana-备份恢复" class="headerlink" title="grafana 备份恢复"></a>grafana 备份恢复</h3><p>[×] grafana 备份丢失，无法恢复</p>
<h3 id="模拟数据配置"><a href="#模拟数据配置" class="headerlink" title="模拟数据配置"></a>模拟数据配置</h3><h4 id="技术方案采用的前提："><a href="#技术方案采用的前提：" class="headerlink" title="技术方案采用的前提："></a>技术方案采用的前提：</h4><ul>
<li>[×] grafana 数据源插件 csv data source 和 infinity data - source 都不支持s390x架构！！</li>
<li>[×] 用数据库存模拟数据太麻烦<h4 id="技术方案："><a href="#技术方案：" class="headerlink" title="技术方案："></a>技术方案：</h4>[√] 用 python 脚本模拟了类似于这样的 zhmc_prometheus_exporter 的监测到的partition_processor_usage_ratio 数据：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># HELP partition_processor_usage_ratio Processor usage ratio for a partition</span><br><span class="line"># TYPE partition_processor_usage_ratio gauge</span><br><span class="line">partition_processor_usage_ratio&#123;cpc=&quot;BZ12&quot;, hmc=&quot;HMC1&quot;, instance=&quot;172.16.36.127:9293&quot;, job=&quot;zhmc&quot;, partition=&quot;LPAR28&quot;, pod=&quot;mypod&quot;&#125; 0.77</span><br><span class="line">partition_processor_usage_ratio&#123;cpc=&quot;BZ12&quot;, hmc=&quot;HMC1&quot;, instance=&quot;172.16.36.127:9293&quot;, job=&quot;zhmc&quot;, partition=&quot;LPAR29&quot;, pod=&quot;mypod&quot;&#125; 0.55</span><br><span class="line">partition_processor_usage_ratio&#123;cpc=&quot;BZ12&quot;, hmc=&quot;HMC1&quot;, instance=&quot;172.16.36.127:9293&quot;, job=&quot;zhmc&quot;, partition=&quot;LPAR30&quot;, pod=&quot;mypod&quot;&#125; 0.64</span><br></pre></td></tr></table></figure>
<p>在 LinuxOne 服务器上，~/python_server目录下，有三个文件：<code>metrics_server.py</code>, <code>requirements.txt</code>, <code>Dockerfile</code>，其中<code>metrics_server.py</code>是模拟数据的脚本，<code>requirements.txt</code>是依赖包列表，<code>Dockerfile</code>是打包镜像的脚本。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># v0.1.0</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机的指标值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_usage</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">round</span>(random.uniform(<span class="number">0.3</span>, <span class="number">1.0</span>), <span class="number">2</span>)  <span class="comment"># 生成一个 0.3 到 1.0 之间的随机值 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成符合 Prometheus 格式的时间序列数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_metrics</span>():</span><br><span class="line">    <span class="comment"># 使用拼接方式构建模拟指标数据，目前是随机的三个partition的CPU利用率，每次请求都会生成新的随机值</span></span><br><span class="line">    metrics = []</span><br><span class="line">    metrics.append(<span class="string">&quot;# HELP partition_processor_usage_ratio Processor usage ratio for a partition&quot;</span>)</span><br><span class="line">    metrics.append(<span class="string">&quot;# TYPE partition_processor_usage_ratio gauge&quot;</span>)</span><br><span class="line">    metrics.append(<span class="string">f&#x27;partition_processor_usage_ratio&#123;&#123;cpc=&quot;BZ12&quot;, hmc=&quot;HMC1&quot;, instance=&quot;172.16.36.127:9293&quot;, job=&quot;zhmc&quot;, partition=&quot;LPAR28&quot;, pod=&quot;mypod&quot;&#125;&#125; <span class="subst">&#123;generate_random_usage()&#125;</span>&#x27;</span>)</span><br><span class="line">    metrics.append(<span class="string">f&#x27;partition_processor_usage_ratio&#123;&#123;cpc=&quot;BZ12&quot;, hmc=&quot;HMC1&quot;, instance=&quot;172.16.36.127:9293&quot;, job=&quot;zhmc&quot;, partition=&quot;LPAR29&quot;, pod=&quot;mypod&quot;&#125;&#125; <span class="subst">&#123;generate_random_usage()&#125;</span>&#x27;</span>)</span><br><span class="line">    metrics.append(<span class="string">f&#x27;partition_processor_usage_ratio&#123;&#123;cpc=&quot;BZ12&quot;, hmc=&quot;HMC1&quot;, instance=&quot;172.16.36.127:9293&quot;, job=&quot;zhmc&quot;, partition=&quot;LPAR30&quot;, pod=&quot;mypod&quot;&#125;&#125; <span class="subst">&#123;generate_random_usage()&#125;</span>&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n&quot;</span>.join(metrics)  <span class="comment"># 将列表连接为字符串</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/metrics&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">metrics</span>():</span><br><span class="line">    metrics_data = generate_metrics()</span><br><span class="line">    <span class="keyword">return</span> Response(metrics_data, mimetype=<span class="string">&quot;text/plain&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure></p>
<p>在 <code>~/python_server</code> 这个目录下，执行以下命令，可以打包镜像并运行容器（目前，<strong>每次更换新的 metrics_server.py 脚本都需要执行一遍</strong>）：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打包数据模拟服务镜像</span></span><br><span class="line">sudo docker build -t flask_metrics_server .</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行数据模拟服务的容器</span></span><br><span class="line">sudo docker run -d --network monitoring -p 8080:8080 --name flask_metrics flask_metrics_server</span><br></pre></td></tr></table></figure><br>[√] 把模拟数据的脚本打包一个镜像跑在 8080 端口上，作为 prometheus 的 target 之一，然后再添加 prometheus 为 grafana 的数据源。容器跑起来之后，以下命令可以调用服务查看模拟数据的具体情况：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -G &#x27;http://localhost:8080/metrics&#x27;</span><br></pre></td></tr></table></figure></p>
<h4 id="下一步工作"><a href="#下一步工作" class="headerlink" title="下一步工作"></a>下一步工作</h4><ol>
<li>[×] 完善数据模拟脚本<ul>
<li>还有一个 <code>cpc_processor_usage_ratio</code> 的指标。</li>
<li>需要更有规律的数据，而不是随机的，以便于让算法训练</li>
</ul>
</li>
<li><p>[×] grafana dashboard 重建CPU监控面板，展示cpc（可选择不同cpc）的总的cpu利用率 和 partition（可选择不同 partition）的CPU利用率的时间序列图</p>
</li>
<li><p>[×] 添加cpu的告警规则，设置告警通知 webhook(需要先把LOP-API的容器跑起来)</p>
</li>
<li><p>[×] 前端把原本面板url改成最新重建的CPU监控面板的 url</p>
<ul>
<li>ps，之前做过的其他面板如果有图片保存可以放一点图片上去，或者后面直接放在视频上</li>
</ul>
</li>
<li>[×] 前端添加关于AI预测相关的页面</li>
<li>[×] 前端服务打包部署在服务器上容器启动</li>
<li>[×] AI的训练预测服务，可以参照数据模拟服务的方式部署上线</li>
</ol>
<h3 id="遇到的问题："><a href="#遇到的问题：" class="headerlink" title="遇到的问题："></a>遇到的问题：</h3><ul>
<li>技术方案从数据源插件到 pushgateway 到自己写脚本模拟数据，再到打包成镜像部署。<ul>
<li>如上，s390x 架构的生态支持真的很一般</li>
<li>pushgateway 要求不带时间戳，并且也不允许一次推送多个相同的指标，这样就不适合模拟数据了，因为我们需要的是时间序列数据，而不是单个数据点。</li>
</ul>
</li>
<li>最开始生成的指标数据是一大串字符串，prometheus报错指标名称不符合规范，看起来是混进去了一个前导空格，后面改成 extnds 的方式拼接指标数据，就好了。 </li>
<li>部署成功之后，在Prometheus上的target是up的，但是不管是 grafana 还是 prometheus 都找不到指标。确认了好几次之后看 prometheus 的日志，发现是因为手动添加的时间戳不对导致的。</li>
<li>时间戳问题：一开始以为只有用 pushgateway 才不用添加时间戳，然后因为服务器是跨境的，时区是UTC，脚本中标注了，返回的也是不对的，都是CST，不知道为什么。后来搞了半天发现。虽然 prometheus 强制要求时间戳，但是其实也可以不用手动添加时间戳，因为 prometheus 会自己添加时间戳。</li>
<li>最后终于成功了，找到指标了，但是grafana上面没有数据显示，这次我学聪明了，应该是浏览器和服务器的时区不一样导致的，grafana 的 webGUI 自动跟随了浏览器的时区。在grafana的设置里面设置了UTC时区，然后就好了。</li>
<li>吐槽一下，linuxone 服务器几十秒不动就会自动断开连接，真的很烦，每次都要重新连。</li>
</ul>
<h4 id="汇报方面"><a href="#汇报方面" class="headerlink" title="汇报方面"></a>汇报方面</h4><ul>
<li>项目介绍：LOP-API 是一个用于监控 IBM Z 系统的 API，提供了一套用于监控 CPC、Adapter、Partition 等资源的指标数据，以及告警规则和通知服务。</li>
<li>故事背景：客户是一家大型企业，拥有多台 IBM Z 系统，希望能够通过 Grafana 实时监控 CPC 和 Partition 的 CPU 利用率，并设置告警规则，以便在 CPU 利用率过高时及时通知。</li>
<li>需求痛点：客户的 IBM Z 系统是企业的核心设备，CPU 利用率过高可能会导致系统性能下降，甚至影响业务运行。因此，客户希望能够及时监控 CPU 利用率，并在必要时采取措施。</li>
<li>项目需求：客户希望能够通过 Grafana 实时监控 CPC 和 Partition 的 CPU 利用率，并设置告警规则，以便在 CPU 利用率过高时及时通知。</li>
<li>解决方案：我们为客户提供了一个实时监控 CPC 和 Partition CPU 利用率的解决方案，通过 zhmc_prometheus_exporter 采集 CPC 和 Partition 的 CPU 利用率数据，并将其推送到 Prometheus 中。然后，我们在 Grafana 中创建了一个 CPU 监控面板，展示了 CPC 的总 CPU 利用率和 Partition 的 CPU 利用率的时间序列图。我们还设置了告警规则，当 CPU 利用率超过阈值时，会触发告警并发送通知。除此之外，我们还将机器学习算法应用于监控数据，以提供更准确的预测和分析服务，这样可以提前发现潜在的问题并采取措施。</li>
<li>项目成果：我们成功地实现了客户的需求，为客户提供了一个实时监控 CPC 和 Partition CPU 利用率的解决方案，并设置了告警规则，以便在 CPU 利用率过高时及时通知客户。</li>
<li>项目展望：未来，我们计划进一步优化监控面板，添加更多的监控指标和告警规则，以提供更全面的监控服务。</li>
</ul>
<h1 id="最终梳理汇报"><a href="#最终梳理汇报" class="headerlink" title="最终梳理汇报"></a>最终梳理汇报</h1><p>我们的项目基于 s390x 架构开发和部署，所有的服务拆分并建立于各种镜像与容器之上，依托 zhmc_prometheus_exporter 提供的基础能力， 我们使用 Prometheus 和 Grafana 采集 LinuxOne 平台的各个方面的指标，如 CPU 利用率、内存使用率、网络IO吞吐量等关键指标，并且我们针对LinuxOne 平台用户的独特需求，从 CPC 到 Adapter 再到 Partition，从 Network adapter 和到 虚拟网卡 NIC，提供了一套完整的、立体的监控解决方案。针对多个层面提供了立体的监控体系，让用户可以更加深入内部，从每一台机器到每一个分区，每一个网卡设备，每一个虚拟网卡设备，数据包和字节的使用情况，都能够清晰地展现在用户面前。</p>
<p>我们站在用户的角度对于这套系统的可用性和易用性进行了优化，提供了告警规则和通知服务，当指标超过阈值的时候，可以通过邮件等方式及时通知用户，并附带我们建议的应对策略，让用户可以及时采取相应措施，保证系统和服务的稳定性和可靠性。而监控最终是为保证服务的稳定性和可靠性存在的，但不同的用户对于监控的需求是不同的，我们提供了一套灵活的监控方案，在我们提供的专业监控服务之外，用户可以根据自己的需求定制监控面板，选择自己关心的指标，设置自己关心的告警规则，让监控更加贴合用户的需求。</p>
<p>我们的系统会实时针对告警信息进行分析和处理，除了将告警信息以及对应的应对策略送达用户之外，我们也将这些数据通过 MariaDB 关系型数据库进行持久化存储，不仅为用户提供历史告警信息的查询和展示，让用户可以更好地了解系统的运行情况，还能为未来的进一步深入拓展和更宏观的监控解决方案提供了研究的基础。</p>
<p>我们并不止步于提供实时监控的服务，在广泛地调研了种类特性繁多的机器学习算法之后，我们最终选取了几个最适合我们应用场景的 ARIMA、Prophet、DeepAR 三种时序预测算法，并将其应用于监控数据，并在通过模型的计算和推理之后，将未来指标的走向预测结果返回给用户，帮助用户防范于未然，使得用户能够提前发现潜在的问题并采取措施。</p>
<p>在未来，除了典型的监控指标，我们可以针对 SAN Switch 和存储进行监控，全方位地监控整个 LinuxOne 系统，为用户提供更全面和个性化的监控服务。我们还可以让 AI算法根据实时的真实数据反馈来不断自适应调整参数，不断微调预测模型。</p>
<h1 id="总结经验梳理"><a href="#总结经验梳理" class="headerlink" title="总结经验梳理"></a>总结经验梳理</h1><h2 id="s390x-和-x86-架构的差异"><a href="#s390x-和-x86-架构的差异" class="headerlink" title="s390x 和 x86 架构的差异"></a>s390x 和 x86 架构的差异</h2><p>IBM 的 <strong>s390x</strong> 架构（IBM Z 和 LinuxONE 系统的基础）和 <strong>x86 架构</strong>（Intel 和 AMD 的通用处理器架构）有显著的差异。这些差异体现在架构设计、指令集、应用场景和性能优化等多个方面。</p>
<hr>
<h3 id="1-基本架构设计"><a href="#1-基本架构设计" class="headerlink" title="1. 基本架构设计"></a><strong>1. 基本架构设计</strong></h3><div class="table-container">
<table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>s390x</strong></th>
<th><strong>x86</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>架构类型</strong></td>
<td><strong>CISC</strong>（复杂指令集计算）</td>
<td><strong>CISC</strong>（复杂指令集计算）</td>
</tr>
<tr>
<td><strong>字长</strong></td>
<td>64 位</td>
<td>32 位（x86）和 64 位（x86-64）</td>
</tr>
<tr>
<td><strong>字节序</strong></td>
<td><strong>大端（Big-endian）</strong></td>
<td><strong>小端（Little-endian）</strong></td>
</tr>
<tr>
<td><strong>寄存器数量</strong></td>
<td>16 个通用寄存器，16 个浮点寄存器</td>
<td>多达 16 个通用寄存器（64 位模式），更多的浮点寄存器</td>
</tr>
<tr>
<td><strong>虚拟化</strong></td>
<td>硬件层面支持大量虚拟化实例，专为高效率虚拟化设计</td>
<td>支持虚拟化，但需要通过扩展（如 VT-x 或 AMD-V）实现</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 id="2-指令集"><a href="#2-指令集" class="headerlink" title="2. 指令集"></a><strong>2. 指令集</strong></h3><h4 id="s390x"><a href="#s390x" class="headerlink" title="s390x"></a><strong>s390x</strong></h4><ul>
<li>专为大型企业计算设计，支持高度优化的批量处理、事务处理和加密操作。</li>
<li>包含专用指令集，优化了主机任务（如 I/O 操作、高吞吐量处理）。</li>
<li>内置高级加密指令（如 DES、AES、SHA）以支持数据加密需求。</li>
<li>设计目标是高可靠性、高可用性和高可扩展性。</li>
</ul>
<h4 id="x86"><a href="#x86" class="headerlink" title="x86"></a><strong>x86</strong></h4><ul>
<li>广泛通用，支持从个人电脑到数据中心的各种场景。</li>
<li>指令集复杂且历史悠久，向后兼容性很强，但存在冗余。</li>
<li>包括向量化指令扩展（如 SSE、AVX），适合多媒体和科学计算。</li>
<li>面向通用计算设计，灵活性更高，但效率未必最优。</li>
</ul>
<hr>
<h3 id="3-内存管理"><a href="#3-内存管理" class="headerlink" title="3. 内存管理"></a><strong>3. 内存管理</strong></h3><h4 id="s390x-1"><a href="#s390x-1" class="headerlink" title="s390x"></a><strong>s390x</strong></h4><ul>
<li>使用 <strong>段表 + 页表</strong> 的两级存储管理，支持非常大的地址空间（高达 16 EB）。</li>
<li>专注于高效管理大规模内存，尤其适合运行多个虚拟机和容器。</li>
<li>支持内存压缩和高效的缓存管理，降低主机资源消耗。</li>
</ul>
<h4 id="x86-1"><a href="#x86-1" class="headerlink" title="x86"></a><strong>x86</strong></h4><ul>
<li>支持分页机制，较新的扩展（如 PAE 和 64 位模式）增加了地址空间。</li>
<li>针对通用计算场景设计，专为桌面、服务器和嵌入式系统优化。</li>
</ul>
<hr>
<h3 id="4-应用场景"><a href="#4-应用场景" class="headerlink" title="4. 应用场景"></a><strong>4. 应用场景</strong></h3><h4 id="s390x-2"><a href="#s390x-2" class="headerlink" title="s390x"></a><strong>s390x</strong></h4><ul>
<li>面向<strong>企业级计算</strong>和<strong>主机任务</strong>：<ul>
<li>银行交易处理</li>
<li>数据库管理</li>
<li>高安全性要求的工作负载（如加密处理）</li>
<li>高可靠性任务，如核心金融系统、航空预订系统等</li>
</ul>
</li>
<li>支持大量并发任务，强调吞吐量和可靠性。</li>
</ul>
<h4 id="x86-2"><a href="#x86-2" class="headerlink" title="x86"></a><strong>x86</strong></h4><ul>
<li>面向<strong>通用计算</strong>场景：<ul>
<li>台式机和笔记本电脑</li>
<li>云计算和服务器（通过扩展支持虚拟化）</li>
<li>高性能计算（HPC）和图形处理（与 GPU 协作）</li>
<li>消费电子设备、嵌入式系统。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="5-性能优化"><a href="#5-性能优化" class="headerlink" title="5. 性能优化"></a><strong>5. 性能优化</strong></h3><h4 id="s390x-3"><a href="#s390x-3" class="headerlink" title="s390x"></a><strong>s390x</strong></h4><ul>
<li><strong>可靠性</strong>：支持硬件级故障检测与自动恢复，几乎零宕机时间。</li>
<li><strong>高密度虚拟化</strong>：通过 PR/SM（Processor Resource/System Manager）和 KVM（Kernel-based Virtual Machine），可在同一物理机上运行数千个虚拟机实例。</li>
<li><strong>加密性能</strong>：专用硬件加速加密任务，适合需要高安全性的环境。</li>
<li><strong>I/O 性能</strong>：支持高带宽 I/O，优化磁盘、网络的吞吐量。</li>
</ul>
<h4 id="x86-3"><a href="#x86-3" class="headerlink" title="x86"></a><strong>x86</strong></h4><ul>
<li><strong>灵活性</strong>：适合各种通用场景，扩展性强。</li>
<li><strong>指令并行化</strong>：通过扩展（如 AVX-512）提升计算密集型任务的性能。</li>
<li><strong>多核支持</strong>：通过增加核心数量提升并发性能。</li>
<li><strong>性价比</strong>：低成本、高性能的通用处理器，广泛应用于消费级和商业市场。</li>
</ul>
<hr>
<h3 id="6-系统支持和软件生态"><a href="#6-系统支持和软件生态" class="headerlink" title="6. 系统支持和软件生态"></a><strong>6. 系统支持和软件生态</strong></h3><h4 id="s390x-4"><a href="#s390x-4" class="headerlink" title="s390x"></a><strong>s390x</strong></h4><ul>
<li>系统：支持专为其优化的操作系统（如 IBM z/OS、Linux on IBM Z）。</li>
<li>应用生态：以企业软件为主（如 IBM Db2、Oracle Database），同时支持现代开源软件（如 Docker、Kubernetes）。</li>
<li>硬件专属：需要专用硬件，生态相对封闭。</li>
</ul>
<h4 id="x86-4"><a href="#x86-4" class="headerlink" title="x86"></a><strong>x86</strong></h4><ul>
<li>系统：支持几乎所有主流操作系统（如 Windows、Linux、macOS）。</li>
<li>应用生态：软件兼容性极高，涵盖桌面、服务器、移动和嵌入式场景。</li>
<li>硬件开放：多厂商支持（如 Intel、AMD），生态非常开放。</li>
</ul>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><div class="table-container">
<table>
<thead>
<tr>
<th><strong>对比点</strong></th>
<th><strong>s390x</strong></th>
<th><strong>x86</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>定位</strong></td>
<td>企业级计算，专注于高可靠性和高吞吐量</td>
<td>通用计算，适用于广泛的使用场景</td>
</tr>
<tr>
<td><strong>生态</strong></td>
<td>封闭，专用性强，针对企业场景优化</td>
<td>开放，灵活性高，通用性更广</td>
</tr>
<tr>
<td><strong>性能侧重</strong></td>
<td>高 I/O 吞吐量、虚拟化密度、高可靠性</td>
<td>性价比高、通用性能强、灵活扩展</td>
</tr>
<tr>
<td><strong>目标用户</strong></td>
<td>银行、金融机构、大型企业</td>
<td>消费者、通用企业、HPC 用户</td>
</tr>
</tbody>
</table>
</div>
<p>如果你的需求是处理高安全性、大吞吐量和高可靠性的任务（如银行核心业务），<strong>s390x 是理想选择</strong>。如果需要通用计算能力和灵活扩展性（如云计算和个人计算），<strong>x86 是更适合的选择</strong>。</p>
<h2 id="Prometheus-和-open-telemetry-的联系"><a href="#Prometheus-和-open-telemetry-的联系" class="headerlink" title="Prometheus 和 open telemetry 的联系"></a>Prometheus 和 open telemetry 的联系</h2><p><strong>OpenTelemetry 和 Prometheus 的比较</strong></p>
<p>OpenTelemetry 和 Prometheus 都是监控和观察工具链的重要组成部分，但它们专注的领域和功能不同。以下是它们的介绍和对比：</p>
<hr>
<h3 id="OpenTelemetry-简介"><a href="#OpenTelemetry-简介" class="headerlink" title="OpenTelemetry 简介"></a><strong>OpenTelemetry 简介</strong></h3><p>OpenTelemetry 是一个开源项目，旨在为分布式系统提供统一的追踪（Tracing）、指标（Metrics）和日志（Logs）采集框架。它是 CNCF（云原生计算基金会）项目之一，由 OpenTracing 和 OpenCensus 合并而成。</p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a><strong>特点</strong></h4><ol>
<li><strong>跨语言支持</strong>：支持多种编程语言（如 Java、Python、Go、Rust 等）。</li>
<li><strong>数据种类多样</strong>：可处理追踪、指标和日志，适合分布式微服务的全方位监控。</li>
<li><strong>标准化</strong>：提供一致的 API 和 SDK，支持多个后端（如 Prometheus、Grafana Tempo、Jaeger、Zipkin）。</li>
<li><strong>灵活性</strong>：支持不同的导出器，可以将数据发送到不同的 APM（应用性能监控）平台。</li>
<li><strong>集成性强</strong>：可与服务网格（如 Istio）、消息队列（如 Kafka）等直接集成。</li>
</ol>
<h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a><strong>适用场景</strong></h4><ul>
<li>分布式系统的性能监控和诊断。</li>
<li>微服务架构下的全链路追踪和依赖分析。</li>
<li>应用日志与性能指标的关联分析。</li>
</ul>
<hr>
<h3 id="Prometheus-简介"><a href="#Prometheus-简介" class="headerlink" title="Prometheus 简介"></a><strong>Prometheus 简介</strong></h3><p>Prometheus 是一个用于<strong>时间序列指标（Time Series Metrics）</strong>监控的开源系统，也属于 CNCF 项目。它专注于指标的采集、存储和查询，特别适用于监控基础设施和服务。</p>
<h4 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a><strong>特点</strong></h4><ol>
<li><strong>高效时间序列数据库</strong>：内置时间序列数据库，用于存储指标数据。</li>
<li><strong>拉取模型（Pull-based）</strong>：通过 HTTP 从目标拉取数据，支持灵活的目标发现。</li>
<li><strong>PromQL</strong>：功能强大的查询语言，用于分析指标数据。</li>
<li><strong>告警集成</strong>：内置 Alertmanager，可以配置复杂的告警规则。</li>
<li><strong>生态系统成熟</strong>：与 Grafana 等工具无缝集成，提供多种插件。</li>
</ol>
<h4 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a><strong>适用场景</strong></h4><ul>
<li>基础设施监控，如服务器、容器、Kubernetes。</li>
<li>服务指标监控，如 HTTP 请求延迟、CPU 使用率等。</li>
<li>系统健康状态监控和实时告警。</li>
</ul>
<hr>
<h3 id="比较"><a href="#比较" class="headerlink" title="比较"></a><strong>比较</strong></h3><div class="table-container">
<table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>OpenTelemetry</strong></th>
<th><strong>Prometheus</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>关注点</strong></td>
<td>追踪、指标、日志的统一采集和分布式追踪</td>
<td>时间序列指标采集和监控</td>
</tr>
<tr>
<td><strong>数据采集模式</strong></td>
<td>推送（Push-based）</td>
<td>拉取（Pull-based）</td>
</tr>
<tr>
<td><strong>生态系统</strong></td>
<td>支持多种后端（Prometheus、Jaeger、Zipkin 等）</td>
<td>专注于 Prometheus 自己的存储与查询</td>
</tr>
<tr>
<td><strong>语言支持</strong></td>
<td>多语言支持（API 和 SDK 丰富）</td>
<td>限制较少，但需搭配 Exporter 来支持特定语言</td>
</tr>
<tr>
<td><strong>存储方式</strong></td>
<td>不负责存储，依赖外部后端（如 Prometheus 或 Jaeger）</td>
<td>自带时序数据库</td>
</tr>
<tr>
<td><strong>查询能力</strong></td>
<td>不提供查询语言，需依赖后端实现</td>
<td>自带 PromQL，功能强大</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>强，适用于复杂场景（多后端、多数据类型）</td>
<td>单一领域深入，指标监控性能高</td>
</tr>
<tr>
<td><strong>分布式追踪</strong></td>
<td>内置支持</td>
<td>不支持</td>
</tr>
<tr>
<td><strong>学习曲线</strong></td>
<td>较高，需配置 SDK、收集器和导出器</td>
<td>较低，上手较快</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a><strong>总结</strong></h3><ul>
<li><strong>选择 OpenTelemetry</strong>：当你的系统是分布式架构，并且需要统一处理追踪、指标和日志时，OpenTelemetry 是首选。它的灵活性和多后端支持使其成为现代微服务架构的强大工具。</li>
<li><strong>选择 Prometheus</strong>：如果你的主要需求是监控基础设施和服务性能（如 CPU 使用率、请求延迟等），并且需要内置存储和告警功能，Prometheus 是理想选择。</li>
</ul>
<p><strong>推荐结合使用</strong>：  </p>
<ul>
<li><strong>OpenTelemetry</strong> 可以作为数据采集层，通过配置导出器将指标数据推送到 <strong>Prometheus</strong>，实现统一采集和指标监控的最佳实践。</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://val213.github.io">Val</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://val213.github.io/2024/05/31/IBM%E4%BF%B1%E4%B9%90%E9%83%A8/IBM%E8%81%94%E5%90%88%E7%A7%91%E7%A0%94%E9%A1%B9%E7%9B%AE/">https://val213.github.io/2024/05/31/IBM%E4%BF%B1%E4%B9%90%E9%83%A8/IBM%E8%81%94%E5%90%88%E7%A7%91%E7%A0%94%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Prometheus/">Prometheus</a><a class="post-meta__tags" href="/tags/Grafana/">Grafana</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/31/%E5%B7%A5%E5%85%B7/Prometheus+grafana/" title="Prometheus+Grafana"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Prometheus+Grafana</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/24/IBM%E4%BF%B1%E4%B9%90%E9%83%A8/%E3%80%90IBM%E3%80%91%E8%AE%B2%E5%BA%A7%E9%80%89%E9%A2%98%E8%B0%83%E6%9F%A5/" title="IBM主机创新俱乐部讲座主题兴趣调查"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">IBM主机创新俱乐部讲座主题兴趣调查</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://github.com/val213/image/blob/main/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20230630230143.jpg?raw=true" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Val</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">135</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">108</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/val213"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/val213" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:val213666@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">记录跬步 e/acc</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">前置工作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-Grafana"><span class="toc-number">1.1.1.</span> <span class="toc-text">Prometheus+Grafana</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Prometheus-%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">Prometheus 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Grafana-%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Grafana 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exporter-%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">exporter 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tips"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">tips</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Prometheus使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Grafana%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">Grafana使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AF%8F%E5%91%A8%E5%AD%A6%E4%B9%A0-%E5%BC%80%E5%8F%91%E6%8A%A5%E5%91%8A"><span class="toc-number">2.</span> <span class="toc-text">每周学习&#x2F;开发报告</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%91%A8"><span class="toc-number">2.1.</span> <span class="toc-text">第一周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFrestful-API"><span class="toc-number">2.1.1.</span> <span class="toc-text">什么是restful API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cherrypy"><span class="toc-number">2.1.2.</span> <span class="toc-text">cherrypy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8py%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84restful-API"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">用py编写一个简单的restful API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tutorials"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">tutorials</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Tutorial-4-Submit-this-form"><span class="toc-number">2.1.2.2.1.</span> <span class="toc-text">Tutorial 4: Submit this form</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Tutorial-5-Track-my-end-user%E2%80%99s-activity"><span class="toc-number">2.1.2.2.2.</span> <span class="toc-text">Tutorial 5: Track my end-user’s activity</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Tutorial-7-Give-us-a-REST"><span class="toc-number">2.1.2.2.3.</span> <span class="toc-text">Tutorial 7: Give us a REST</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Tutorial-9-Data-is-all-my-life"><span class="toc-number">2.1.2.2.4.</span> <span class="toc-text">Tutorial 9: Data is all my life</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Tutorial-11-Organize-my-code"><span class="toc-number">2.1.2.2.5.</span> <span class="toc-text">Tutorial 11: Organize my code</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#dispatchers"><span class="toc-number">2.1.2.2.5.1.</span> <span class="toc-text">dispatchers</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#tools"><span class="toc-number">2.1.2.2.5.2.</span> <span class="toc-text">tools</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#plugins"><span class="toc-number">2.1.2.2.5.3.</span> <span class="toc-text">plugins</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Tutorial-12-Using-pytest-and-code-coverage"><span class="toc-number">2.1.2.2.6.</span> <span class="toc-text">Tutorial 12: Using pytest and code coverage</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APIDOC"><span class="toc-number">2.1.3.</span> <span class="toc-text">APIDOC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%8F%AF%E8%A7%82%E6%B5%8B"><span class="toc-number">2.1.4.</span> <span class="toc-text">关于可观测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Metrics%EF%BC%8C%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">Metrics，监控指标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Logs%EF%BC%8C%E6%97%A5%E5%BF%97"><span class="toc-number">2.1.4.2.</span> <span class="toc-text">Logs，日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Traces%EF%BC%8C%E8%BF%BD%E8%B8%AA"><span class="toc-number">2.1.4.3.</span> <span class="toc-text">Traces，追踪</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E5%91%A8%E7%9B%AE%E6%A0%87"><span class="toc-number">2.1.5.</span> <span class="toc-text">下周目标</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%91%A8"><span class="toc-number">2.2.</span> <span class="toc-text">第二周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%8A%E7%94%A8docker%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F"><span class="toc-number">2.2.1.</span> <span class="toc-text">在虚拟机上用docker拉取镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Ubuntu%E4%B8%8A%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEMaria-DB"><span class="toc-number">2.2.2.</span> <span class="toc-text">在Ubuntu上安装配置Maria DB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1-%E5%AE%89%E8%A3%85-MariaDB"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">步骤 1: 安装 MariaDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2-%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE-MariaDB"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">步骤 2: 安全配置 MariaDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3-%E9%85%8D%E7%BD%AE-MariaDB-%E7%94%A8%E6%88%B7%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">步骤 3: 配置 MariaDB 用户（可选）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4-%E6%B5%8B%E8%AF%95-MariaDB-%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">步骤 4: 测试 MariaDB 安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEdockers%E7%8E%AF%E5%A2%83%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E5%90%AF%E5%8A%A8%E4%BA%86%E5%AE%B9%E5%99%A8%E4%BD%86%E6%98%AF%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%88%B0%E7%AB%AF%E5%8F%A3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.3.</span> <span class="toc-text">配置dockers环境过程中遇到启动了容器但是访问不到端口的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-compose-yml"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">docker-compose.yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prometheus-yml"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">prometheus.yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-daemon-json"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">docker&#x2F;daemon.json</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%BA%A7%E5%88%AB%E7%9A%84%E5%8C%85%E8%BF%87%E6%BB%A4%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">内核级别的包过滤系统</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%A6%E5%88%B0%E4%BA%86%E5%85%B6%E4%BB%96%E7%9A%84%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">学到了其他的一些命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%81"><span class="toc-number">2.2.3.6.</span> <span class="toc-text">真正的解决方法！</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-exporter%E9%83%A8%E7%BD%B2"><span class="toc-number">2.2.4.</span> <span class="toc-text">node_exporter部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA%E4%B8%8A%E9%83%A8%E7%BD%B2node-exporter"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">在宿主机上部署node_exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EPrometheus%E8%AE%BF%E9%97%AE%E4%B8%8D%E5%88%B0node-exporter%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.4.1.1.</span> <span class="toc-text">关于Prometheus访问不到node_exporter的问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tips%EF%BC%9A"><span class="toc-number">2.2.4.1.2.</span> <span class="toc-text">tips：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Grafana%E5%B1%95%E7%A4%BA%E9%9D%A2%E6%9D%BF"><span class="toc-number">2.2.5.</span> <span class="toc-text">Grafana展示面板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41-%E7%A1%AE%E5%AE%9A-Prometheus-%E5%AE%B9%E5%99%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80"><span class="toc-number">2.2.5.1.</span> <span class="toc-text">步骤1: 确定 Prometheus 容器的网络访问地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42-%E4%B8%BA-Grafana-%E6%B7%BB%E5%8A%A0-Prometheus-%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">2.2.5.2.</span> <span class="toc-text">步骤2: 为 Grafana 添加 Prometheus 数据源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E7%9B%91%E6%8E%A7MariaDB"><span class="toc-number">2.2.6.</span> <span class="toc-text">尝试监控MariaDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41-%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85mysqld-exporter"><span class="toc-number">2.2.6.1.</span> <span class="toc-text">步骤1: 下载并安装mysqld_exporter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42-%E9%85%8D%E7%BD%AE-MariaDB-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="toc-number">2.2.6.2.</span> <span class="toc-text">步骤2: 配置 MariaDB 访问权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A43-%E9%85%8D%E7%BD%AEmysqld-exporter"><span class="toc-number">2.2.6.3.</span> <span class="toc-text">步骤3: 配置mysqld_exporter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A44-%E8%BF%90%E8%A1%8Cmysqld-exporter"><span class="toc-number">2.2.6.4.</span> <span class="toc-text">步骤4: 运行mysqld_exporter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A45-%E9%85%8D%E7%BD%AE-Prometheus-%E7%9B%91%E6%8E%A7-mysqld-exporter"><span class="toc-number">2.2.6.5.</span> <span class="toc-text">步骤5: 配置 Prometheus 监控 mysqld_exporter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A46-%E5%9C%A8Grafana%E4%B8%AD%E5%88%9B%E5%BB%BA%E4%BB%AA%E8%A1%A8%E6%9D%BF"><span class="toc-number">2.2.6.6.</span> <span class="toc-text">步骤6: 在Grafana中创建仪表板</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E4%B8%89-%E7%A0%94%E8%AF%BBLOP-API%E8%84%9A%E6%89%8B%E6%9E%B6%E7%9A%84%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.7.</span> <span class="toc-text">任务三 研读LOP-API脚手架的源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E5%9B%9B-Linuxone-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%85%A5%E9%97%A8"><span class="toc-number">2.2.8.</span> <span class="toc-text">任务四 Linuxone 基础知识入门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Linuxone%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%AE%B2%E5%BA%A7"><span class="toc-number">2.3.</span> <span class="toc-text">Linuxone基础知识讲座</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.1.</span> <span class="toc-text">基础介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFLinuxone"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">什么是Linuxone</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">发展历史</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rockhopper-%E2%85%A1-and-Emperor-%E2%85%A1"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">Rockhopper Ⅱ and Emperor Ⅱ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IBM-z14-frame-layout"><span class="toc-number">2.3.1.4.</span> <span class="toc-text">IBM z14 frame layout</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DPM-Dynamic-Partition-Manager"><span class="toc-number">2.3.2.</span> <span class="toc-text">DPM (Dynamic Partition Manager)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#process-and-memory"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">process and memory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU"><span class="toc-number">2.3.3.</span> <span class="toc-text">CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory"><span class="toc-number">2.3.4.</span> <span class="toc-text">Memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Storage"><span class="toc-number">2.3.5.</span> <span class="toc-text">Storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Network"><span class="toc-number">2.3.6.</span> <span class="toc-text">Network</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitor"><span class="toc-number">2.3.7.</span> <span class="toc-text">Monitor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%91%A8%E8%80%83%E8%AF%95%E5%91%A8"><span class="toc-number">2.4.</span> <span class="toc-text">第三周考试周</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E5%91%A8"><span class="toc-number">2.5.</span> <span class="toc-text">第四周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-zhmc-prometheus-exporter"><span class="toc-number">2.5.1.</span> <span class="toc-text">什么是 zhmc-prometheus-exporter ?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo-setup-with-Grafana"><span class="toc-number">2.5.2.</span> <span class="toc-text">Demo setup with Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-metrics%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.5.3.</span> <span class="toc-text">prometheus metrics类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%8C%87%E6%A0%87"><span class="toc-number">2.5.4.</span> <span class="toc-text">核心指标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E7%90%86%E6%A6%82%E5%BF%B5"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">整理概念</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#investigate-how-to-get-network-usage-through-zhmc-exporter"><span class="toc-number">2.5.5.</span> <span class="toc-text">investigate how to get network usage through zhmc exporter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#zhmcclient-%E7%9A%84-NIC-%E7%B1%BB"><span class="toc-number">2.5.5.1.</span> <span class="toc-text">zhmcclient 的 NIC 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zhmcclient-%E7%9A%84-nic"><span class="toc-number">2.5.5.2.</span> <span class="toc-text">zhmcclient 的 nic</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">2.5.5.3.</span> <span class="toc-text">思路</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9roCE%E5%92%8Ccna"><span class="toc-number">2.5.5.3.1.</span> <span class="toc-text">针对roCE和cna</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%92%88%E5%AF%B9osd%E5%92%8Ciqd"><span class="toc-number">2.5.5.3.2.</span> <span class="toc-text">针对osd和iqd</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#virtual-switch"><span class="toc-number">2.5.5.4.</span> <span class="toc-text">virtual switch</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E5%91%A8"><span class="toc-number">2.6.</span> <span class="toc-text">第五周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%BD%A2%E6%88%90%E7%9A%84py%E8%84%9A%E6%9C%AC%EF%BC%88%E5%B9%B6%E4%B8%8D%E9%80%82%E7%94%A8%EF%BC%8C%E5%8F%AA%E7%94%A8%E6%9D%A5%E7%90%86%E8%A7%A3%E6%80%9D%E8%B7%AF%EF%BC%89"><span class="toc-number">2.6.1.</span> <span class="toc-text">思路形成的py脚本（并不适用，只用来理解思路）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E6%83%911"><span class="toc-number">2.6.2.</span> <span class="toc-text">疑惑1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E9%9C%80%E8%A6%81%E8%B0%83%E5%8A%A8%E7%9A%84API%EF%BC%9A"><span class="toc-number">2.6.3.</span> <span class="toc-text">可能需要调动的API：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CPC"><span class="toc-number">2.6.3.1.</span> <span class="toc-text">CPC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Virtual-Switch"><span class="toc-number">2.6.3.2.</span> <span class="toc-text">Virtual Switch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adapter"><span class="toc-number">2.6.3.3.</span> <span class="toc-text">Adapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Port"><span class="toc-number">2.6.3.4.</span> <span class="toc-text">Port</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Partition"><span class="toc-number">2.6.3.5.</span> <span class="toc-text">Partition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NIC"><span class="toc-number">2.6.3.6.</span> <span class="toc-text">NIC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E6%83%912"><span class="toc-number">2.6.4.</span> <span class="toc-text">疑惑2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.6.5.</span> <span class="toc-text">最终解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E5%91%A8"><span class="toc-number">2.7.</span> <span class="toc-text">第六周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E4%BC%BC%E4%BA%A7%E5%93%81%E8%B0%83%E7%A0%94"><span class="toc-number">2.7.1.</span> <span class="toc-text">相似产品调研</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%95%E7%A4%BA"><span class="toc-number">2.7.2.</span> <span class="toc-text">展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E8%BF%AD%E4%BB%A3"><span class="toc-number">2.7.3.</span> <span class="toc-text">重新迭代</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3%E5%8E%86%E7%A8%8B%EF%BC%9A"><span class="toc-number">2.7.3.1.</span> <span class="toc-text">迭代历程：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E5%91%A8"><span class="toc-number">2.8.</span> <span class="toc-text">第七周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nvestigate-how-to-call-own-API-through-grafana-alert-35"><span class="toc-number">2.8.1.</span> <span class="toc-text">nvestigate how to call own API through grafana alert #35</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Design-API-for-alert-36"><span class="toc-number">2.8.2.</span> <span class="toc-text">Design API for alert #36</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E5%90%88%E5%89%8D%E7%AB%AF%E9%9B%86%E6%88%90%E9%A1%B5%E9%9D%A2"><span class="toc-number">2.8.3.</span> <span class="toc-text">配合前端集成页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E5%91%A8"><span class="toc-number">2.9.</span> <span class="toc-text">第八周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%BB%BA-Grafana-%E7%9A%84-dashboard"><span class="toc-number">2.9.1.</span> <span class="toc-text">重建 Grafana 的 dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alert-Manager"><span class="toc-number">2.9.2.</span> <span class="toc-text">Alert-Manager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E5%91%A8"><span class="toc-number">2.10.</span> <span class="toc-text">第九周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E4%BB%BDgrafana"><span class="toc-number">2.10.1.</span> <span class="toc-text">备份grafana</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%91%A8"><span class="toc-number">2.11.</span> <span class="toc-text">第十周</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%A2%B3%E7%90%86%EF%BC%9A"><span class="toc-number">2.11.1.</span> <span class="toc-text">业务逻辑梳理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E9%97%AE%E9%A2%98%E5%8F%8A%E5%85%B6%E8%A7%A3%E5%86%B3"><span class="toc-number">2.11.2.</span> <span class="toc-text">测试过程中的问题及其解决</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%BF%9C%E7%A8%8B%E7%9A%84%E6%B5%8B%E8%AF%95%E6%9C%BA%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E6%88%91%E6%9C%AC%E5%9C%B0%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%9A"><span class="toc-number">2.11.2.1.</span> <span class="toc-text">关于远程的测试机无法访问我本地的服务：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%AF%81%E4%B9%A6%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-number">2.11.2.2.</span> <span class="toc-text">关于证书的问题：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%94%E7%A9%B6-grafana-webhook-%E6%8F%90%E4%BE%9B%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF%E7%9A%84%E5%85%B7%E4%BD%93%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.11.3.</span> <span class="toc-text">研究 grafana webhook 提供具体信息的具体设置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#alert-rules"><span class="toc-number">2.11.3.1.</span> <span class="toc-text">alert rules</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#contact-points"><span class="toc-number">2.11.3.2.</span> <span class="toc-text">contact points</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#notification-policies"><span class="toc-number">2.11.3.3.</span> <span class="toc-text">notification policies</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#code"><span class="toc-number">2.11.3.4.</span> <span class="toc-text">code</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E3%80%81%E5%8D%81%E4%BA%8C%E5%91%A8%EF%BC%88%E4%BC%91%E5%81%87%EF%BC%89"><span class="toc-number">2.12.</span> <span class="toc-text">第十一、十二周（休假）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%94%AE%E5%A4%87%E4%BB%BD-grafana-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.12.1.</span> <span class="toc-text">一键备份 grafana 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%8D%E7%9F%A5%E9%81%93%E7%AC%AC%E5%87%A0%E5%91%A8%EF%BC%8C%E9%A1%B9%E7%9B%AE%E9%87%8D%E5%90%AF%EF%BC%81%E7%9B%AE%E6%A0%87%EF%BC%9A%E5%8D%81%E6%9C%88%E4%B8%AD%E6%97%AC%E5%AE%8C%E6%88%90MVP%E5%92%8C%E6%B1%87%E6%8A%A5%E8%A7%86%E9%A2%91"><span class="toc-number">2.13.</span> <span class="toc-text">第不知道第几周，项目重启！目标：十月中旬完成MVP和汇报视频</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E9%9C%80%E6%B1%82%E8%AE%BE%E6%83%B3"><span class="toc-number">2.13.1.</span> <span class="toc-text">后端开发需求设想</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AI%E6%A8%A1%E5%9D%97"><span class="toc-number">2.13.1.1.</span> <span class="toc-text">AI模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#message%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%8F%A3%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96"><span class="toc-number">2.13.1.2.</span> <span class="toc-text">message模块接口结构优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#grafana-%E9%85%8D%E7%BD%AEnetwork%E7%9A%84%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="toc-number">2.13.1.3.</span> <span class="toc-text">grafana 配置network的告警规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E9%A1%B9%E8%A7%86%E9%A2%91%E5%88%B6%E4%BD%9C"><span class="toc-number">2.13.1.4.</span> <span class="toc-text">结项视频制作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.13.2.</span> <span class="toc-text">数据库连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF"><span class="toc-number">2.14.</span> <span class="toc-text">重新搭建环境部署上线</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C"><span class="toc-number">2.14.1.</span> <span class="toc-text">镜像制作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LOP-API"><span class="toc-number">2.14.1.1.</span> <span class="toc-text">LOP-API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#prometheus%E3%80%81mariaDB"><span class="toc-number">2.14.1.2.</span> <span class="toc-text">prometheus、mariaDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#grafana"><span class="toc-number">2.14.1.3.</span> <span class="toc-text">grafana</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E5%9F%BA%E4%BA%8E%E6%96%87%E4%BB%B6%E7%9A%84-Swap-%E7%A9%BA%E9%97%B4%EF%BC%9A"><span class="toc-number">2.14.1.3.1.</span> <span class="toc-text">如何添加基于文件的 Swap 空间：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%9A"><span class="toc-number">2.14.1.3.2.</span> <span class="toc-text">注意事项：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grafana-%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D"><span class="toc-number">2.14.2.</span> <span class="toc-text">grafana 备份恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E6%95%B0%E6%8D%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">2.14.3.</span> <span class="toc-text">模拟数据配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E9%87%87%E7%94%A8%E7%9A%84%E5%89%8D%E6%8F%90%EF%BC%9A"><span class="toc-number">2.14.3.1.</span> <span class="toc-text">技术方案采用的前提：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">2.14.3.2.</span> <span class="toc-text">技术方案：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E4%B8%80%E6%AD%A5%E5%B7%A5%E4%BD%9C"><span class="toc-number">2.14.3.3.</span> <span class="toc-text">下一步工作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-number">2.14.4.</span> <span class="toc-text">遇到的问题：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B1%87%E6%8A%A5%E6%96%B9%E9%9D%A2"><span class="toc-number">2.14.4.1.</span> <span class="toc-text">汇报方面</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E6%A2%B3%E7%90%86%E6%B1%87%E6%8A%A5"><span class="toc-number">3.</span> <span class="toc-text">最终梳理汇报</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E7%BB%8F%E9%AA%8C%E6%A2%B3%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">总结经验梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#s390x-%E5%92%8C-x86-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B7%AE%E5%BC%82"><span class="toc-number">4.1.</span> <span class="toc-text">s390x 和 x86 架构的差异</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.1.1.</span> <span class="toc-text">1. 基本架构设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-number">4.1.2.</span> <span class="toc-text">2. 指令集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#s390x"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">s390x</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x86"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">x86</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">4.1.3.</span> <span class="toc-text">3. 内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#s390x-1"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">s390x</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x86-1"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">x86</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">4.1.4.</span> <span class="toc-text">4. 应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#s390x-2"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">s390x</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x86-2"><span class="toc-number">4.1.4.2.</span> <span class="toc-text">x86</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">4.1.5.</span> <span class="toc-text">5. 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#s390x-3"><span class="toc-number">4.1.5.1.</span> <span class="toc-text">s390x</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x86-3"><span class="toc-number">4.1.5.2.</span> <span class="toc-text">x86</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%B3%BB%E7%BB%9F%E6%94%AF%E6%8C%81%E5%92%8C%E8%BD%AF%E4%BB%B6%E7%94%9F%E6%80%81"><span class="toc-number">4.1.6.</span> <span class="toc-text">6. 系统支持和软件生态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#s390x-4"><span class="toc-number">4.1.6.1.</span> <span class="toc-text">s390x</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x86-4"><span class="toc-number">4.1.6.2.</span> <span class="toc-text">x86</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.1.7.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus-%E5%92%8C-open-telemetry-%E7%9A%84%E8%81%94%E7%B3%BB"><span class="toc-number">4.2.</span> <span class="toc-text">Prometheus 和 open telemetry 的联系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenTelemetry-%E7%AE%80%E4%BB%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text">OpenTelemetry 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">适用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prometheus-%E7%AE%80%E4%BB%8B"><span class="toc-number">4.2.2.</span> <span class="toc-text">Prometheus 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E7%82%B9-1"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">适用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AF%94%E8%BE%83"><span class="toc-number">4.2.3.</span> <span class="toc-text">比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">4.2.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/12/04/%E8%BF%90%E7%BB%B4/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" title="内网穿透理论与实践"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网穿透理论与实践"/></a><div class="content"><a class="title" href="/2024/12/04/%E8%BF%90%E7%BB%B4/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" title="内网穿透理论与实践">内网穿透理论与实践</a><time datetime="2024-12-03T17:11:12.792Z" title="Created 2024-12-04 01:11:12">2024-12-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/27/%E5%A4%A7%E4%B8%89%E8%AF%BE%E7%A8%8B/%E3%80%90%E5%A4%A7%E4%B8%89%E4%B8%8A%E3%80%91%E5%B7%A5%E4%B8%9A%E6%95%B0%E6%8D%AE/" title="【大三上】工业数据"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【大三上】工业数据"/></a><div class="content"><a class="title" href="/2024/11/27/%E5%A4%A7%E4%B8%89%E8%AF%BE%E7%A8%8B/%E3%80%90%E5%A4%A7%E4%B8%89%E4%B8%8A%E3%80%91%E5%B7%A5%E4%B8%9A%E6%95%B0%E6%8D%AE/" title="【大三上】工业数据">【大三上】工业数据</a><time datetime="2024-11-27T06:13:09.184Z" title="Created 2024-11-27 14:13:09">2024-11-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/25/%E5%BC%80%E5%8F%91/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/dtm/" title="dtm"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="dtm"/></a><div class="content"><a class="title" href="/2024/11/25/%E5%BC%80%E5%8F%91/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/dtm/" title="dtm">dtm</a><time datetime="2024-11-25T07:11:10.400Z" title="Created 2024-11-25 15:11:10">2024-11-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/23/%E5%BC%80%E5%8F%91/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" title="Redis"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis"/></a><div class="content"><a class="title" href="/2024/11/23/%E5%BC%80%E5%8F%91/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" title="Redis">Redis</a><time datetime="2024-11-23T03:33:20.230Z" title="Created 2024-11-23 11:33:20">2024-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/22/%E5%BC%80%E5%8F%91/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A4%BA%E5%91%BD%E8%BF%9E%E7%8E%AF%E9%97%AE/" title="分布式事务夺命连环问"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式事务夺命连环问"/></a><div class="content"><a class="title" href="/2024/11/22/%E5%BC%80%E5%8F%91/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A4%BA%E5%91%BD%E8%BF%9E%E7%8E%AF%E9%97%AE/" title="分布式事务夺命连环问">分布式事务夺命连环问</a><time datetime="2024-11-22T14:47:40.664Z" title="Created 2024-11-22 22:47:40">2024-11-22</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Val</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">纯粹的心，感受意义不明</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>